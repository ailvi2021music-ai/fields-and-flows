<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>–ü–æ–ª—è –∏ –ü–æ—Ç–æ–∫–∏ ‚Äî v0.9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <!-- –®—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;750&display=swap" rel="stylesheet">

  <style>
    :root{
      --glass-dark: rgba(10,14,28,0.72);
      --glass-dark-brd: rgba(255,255,255,0.16);
      --glass-dark-txt: #eaf2ff;

      --glass-light: rgba(255,255,255,0.94);
      --glass-light-brd: rgba(0,0,0,0.12);
      --glass-light-txt: #111;

      --btn-dark: rgba(255,255,255,0.06);
      --btn-dark-brd: rgba(255,255,255,0.16);

      --btn-light: rgba(0,0,0,0.04);
      --btn-light-brd: rgba(0,0,0,0.12);
    }

    html, body {
      margin: 0;
      padding: 0;
      background: #05070d;
      overflow: hidden;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
    }

    canvas {
      display:block;
      touch-action: none; /* –ö–†–ò–¢–ò–ß–ù–û: —á—Ç–æ–±—ã iPad –Ω–µ ‚Äú—Å—ä–µ–¥–∞–ª‚Äù –∂–µ—Å—Ç—ã */
      -webkit-tap-highlight-color: transparent;
    }

    .mode-toggle {
      position: fixed;
      top: 14px;
      right: 14px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.14);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all .25s ease;
      user-select: none;
      z-index: 50;
    }
    .mode-toggle.light {
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.12);
      color: #111;
    }

    .help-btn{
      position: fixed;
      left: 14px;
      bottom: 14px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.14);
      color: #fff;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      user-select:none;
      z-index: 50;
    }
    .help-btn.light{
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.12);
      color:#111;
    }

    .help-pop{
      position: fixed;
      left: 14px;
      bottom: 64px;
      width: 380px;
      max-width: calc(100vw - 28px);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-dark-brd);
      background: var(--glass-dark);
      color: var(--glass-dark-txt);
      padding: 12px;
      box-sizing: border-box;
      display:none;
      z-index: 60;
    }
    .help-pop.open{ display:block; }
    .help-pop.light{
      border-color: var(--glass-light-brd);
      background: var(--glass-light);
      color: var(--glass-light-txt);
    }
    .help-title{
      font-size: 13px;
      font-weight: 750;
      margin: 0 0 8px;
      opacity: .95;
    }
    .help-list{
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
      line-height: 1.35;
      opacity: .9;
    }
    .help-list li{ margin: 4px 0; }
    .kbd{
      font-variant-numeric: tabular-nums;
      border: 1px solid rgba(255,255,255,.18);
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 12px;
      opacity: .9;
    }
    .help-pop.light .kbd{ border-color: rgba(0,0,0,.18); }

    .help-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .panel{
      position: fixed;
      left: 12px;
      top: 12px;

      width: 360px;

      border-radius: 18px;
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-dark-brd);
      background: var(--glass-dark);
      color: var(--glass-dark-txt);

      padding: 12px;
      box-sizing: border-box;

      opacity: 0;
      transform: translate3d(0,0,0) scale(0.98);
      pointer-events: none;

      transition: opacity .16s ease, transform .16s ease;
      z-index: 45;

      max-height: min(680px, 82vh);
      overflow: hidden;

      /* —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –º–µ–Ω—è—Ç—å —à–∏—Ä–∏–Ω—É/–≤—ã—Å–æ—Ç—É –ø–∞–Ω–µ–ª–∏ */
      resize: both;
      min-width: 320px;
      min-height: 220px;
      max-width: calc(100vw - 24px);
      max-height: calc(100vh - 24px);
    }
    .panel.open{
      opacity: 1;
      transform: translate3d(0,0,0) scale(1);
      pointer-events: auto;
    }
    .panel.light{
      border-color: var(--glass-light-brd);
      background: var(--glass-light);
      color: var(--glass-light-txt);
    }
    .panel *::-webkit-scrollbar{ width: 0; height: 0; }
    .panel *{ scrollbar-width: none; }

    .panel-head{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      user-select:none;
      cursor: grab;
      padding: 2px 2px 10px;
    }
    .panel-head:active{ cursor: grabbing; }

    .panel h3{
      margin: 0;
      font-size: 13px;
      font-weight: 750;
      opacity: .95;
    }
    .muted{
      opacity: .72;
      font-size: 12px;
      line-height: 1.25;
    }

    .btn{
      border: 1px solid var(--btn-dark-brd);
      background: var(--btn-dark);
      color: inherit;
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .panel.light .btn{
      border-color: var(--btn-light-brd);
      background: var(--btn-light);
    }

    .icon-btn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
      padding: 0;
    }

    .input{
      width: 100%;
      box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: inherit;
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      font-size: 14px;
    }
    .panel.light .input{
      border-color: rgba(0,0,0,0.14);
      background: rgba(0,0,0,0.03);
    }

    /* Toolbar */
    .rtbar{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 10px;
      align-items: center;
    }
    .rtbtn{
      width: 34px;
      height: 34px;
      border-radius: 11px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.05);
      color: inherit;
      cursor: pointer;
      user-select: none;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      font-size: 13px;
      padding: 0;
    }
    .rtbtn:hover{ background: rgba(255,255,255,0.09); }
    .rtbtn:active{ transform: translateY(1px); }
    .panel.light .rtbtn{
      border-color: rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.03);
    }
    .panel.light .rtbtn:hover{ background: rgba(0,0,0,0.06); }

    .rtsep{
      width: 1px;
      height: 22px;
      background: rgba(255,255,255,0.12);
      margin: 0 2px;
      border-radius: 1px;
    }
    .panel.light .rtsep{ background: rgba(0,0,0,0.10); }

    .rticon{
      width: 18px;
      height: 18px;
      display:block;
      opacity:.95;
    }

    /* –†–µ–¥–∞–∫—Ç–æ—Ä + —Ä–µ—Å–∞–π–∑ –∏–º–µ–Ω–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (–∞ –Ω–µ ‚Äú–≤–Ω–µ—à–Ω–µ–π —Ä–∞–º–∫–∏‚Äù) */
    .editorWrap{
      width: 100%;
      box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      overflow: hidden;
      resize: both;
      min-height: 120px;
      max-height: 55vh;
      min-width: 100%;
      max-width: 100%;
      position: relative;
    }
    .panel.light .editorWrap{
      border-color: rgba(0,0,0,0.14);
      background: rgba(0,0,0,0.03);
    }

    .editor{
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      color: inherit;
      padding: 10px 10px 18px;
      outline: none;
      font-size: 14px;
      overflow: auto;
    }
    .editor:empty:before{
      content: attr(data-placeholder);
      opacity: .45;
    }

    /* –ü–æ–∏—Å–∫ */
    .searchOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 10vh;
      z-index: 70;
    }
    .searchOverlay.open{ display:flex; }

    .searchBox{
      width: min(380px, calc(100vw - 24px));
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,14,28,0.78);
      color: #eaf2ff;
      overflow: hidden;
    }
    .searchBox.light{
      background: rgba(255,255,255,0.94);
      border-color: rgba(0,0,0,0.12);
      color: #111;
    }
    .searchInput{
      width: 100%;
      border: 0;
      outline: none;
      padding: 12px 12px;
      font-size: 14px;
      background: transparent;
      color: inherit;
      box-sizing: border-box;
      font-family: inherit;
    }
    .searchInput::placeholder{ opacity: .42; }

    .results{
      max-height: 38vh;
      overflow: auto;
      border-top: 1px solid rgba(255,255,255,0.12);
    }
    .searchBox.light .results{ border-top-color: rgba(0,0,0,0.10); }

    .item{
      padding: 9px 12px;
      cursor: pointer;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }
    .item:hover{ background: rgba(255,255,255,0.06); }
    .searchBox.light .item:hover{ background: rgba(0,0,0,0.04); }

    .tag{
      opacity:.62;
      font-size: 12px;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<canvas id="field"></canvas>

<div class="mode-toggle" id="modeToggle" title="–°–≤–µ—Ç/–¢—å–º–∞">‚óê</div>

<button class="help-btn" id="helpBtn" title="–ü–æ–º–æ—â—å">?</button>
<div class="help-pop" id="helpPop">
  <div class="help-title">–ö–æ—Ä–æ—Ç–∫–æ</div>
  <ul class="help-list">
    <li>–í—ã–¥–µ–ª–∏—Ç—å: –õ–ö–ú / —Ç–∞–ø</li>
    <li>–ü–∞–Ω–æ—Ä–∞–º–∞: —Ç–∞—â–∏ —Ñ–æ–Ω (–º—ã—à—å/–ø–∞–ª–µ—Ü)</li>
    <li>–ó—É–º: –∫–æ–ª–µ—Å–æ ‚Ä¢ Pinch –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ</li>
    <li>–°–æ–∑–¥–∞—Ç—å —è–¥—Ä–æ: –¥–≤–æ–π–Ω–æ–π –õ–ö–ú –ø–æ –ø—É—Å—Ç–æ—Ç–µ / –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø –ø–æ –ø—É—Å—Ç–æ—Ç–µ</li>
    <li>–°–æ–∑–¥–∞—Ç—å –º—ã—Å–ª—å: –¥–≤–æ–π–Ω–æ–π –õ–ö–ú –ø–æ —è–¥—Ä—É/–º—ã—Å–ª–∏ / –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø –ø–æ —è–¥—Ä—É/–º—ã—Å–ª–∏</li>
    <li>–ü–æ–¥–ª—ë—Ç + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–ö–ú (–∏–ª–∏ –¥–æ–ª–≥–∏–π —Ç–∞–ø)</li>
    <li>–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É: –∫–Ω–æ–ø–∫–∞ ‚ñæ –≤ –ø–∞–Ω–µ–ª–∏</li>
    <li>–ü–æ–∏—Å–∫: <span class="kbd">Ctrl</span>+<span class="kbd">K</span></li>
    <li>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ: <span class="kbd">Del</span> / <span class="kbd">Backspace</span></li>
  </ul>

  <div class="help-actions">
    <button class="btn" id="exportBtn" type="button">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
    <label class="btn" style="cursor:pointer">
      ‚§í –ò–º–ø–æ—Ä—Ç
      <input id="importInput" type="file" accept="application/json" style="display:none">
    </label>
  </div>
</div>

<div class="panel" id="panel">
  <div class="panel-head" id="panelDrag">
    <div>
      <h3 id="panelTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
      <div class="muted" id="panelMeta" style="margin-top:4px;"></div>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn icon-btn" id="btnCollapse" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É">‚ñæ</button>
      <button class="btn icon-btn" id="btnDelete" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
      <button class="btn icon-btn" id="panelClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
  </div>

  <div class="muted" style="margin-bottom:6px;">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
  <input class="input" id="editTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>

  <div style="height:10px;"></div>

  <div class="muted" style="margin-bottom:6px;">–¢–µ–∫—Å—Ç</div>

  <div class="rtbar">
    <button class="rtbtn" id="bBold"   type="button" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
    <button class="rtbtn" id="bItalic" type="button" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
    <button class="rtbtn" id="bUnder"  type="button" title="–ü–æ–¥—á—ë—Ä–∫"><u>U</u></button>

    <div class="rtsep"></div>

    <!-- —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è ‚Äú–ª–∏–Ω–∏—è–º–∏‚Äù, –Ω–µ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ -->
    <button class="rtbtn" id="bLeft"   type="button" title="–í–ª–µ–≤–æ">
      <svg class="rticon" viewBox="0 0 24 24" fill="none">
        <path d="M4 6h14M4 10h10M4 14h14M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="rtbtn" id="bCenter" type="button" title="–¶–µ–Ω—Ç—Ä">
      <svg class="rticon" viewBox="0 0 24 24" fill="none">
        <path d="M5 6h14M7 10h10M5 14h14M7 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="rtbtn" id="bRight"  type="button" title="–í–ø—Ä–∞–≤–æ">
      <svg class="rticon" viewBox="0 0 24 24" fill="none">
        <path d="M6 6h14M10 10h10M6 14h14M10 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="rtsep"></div>

    <button class="rtbtn" id="bLink" type="button" title="–°—Å—ã–ª–∫–∞">
      üîó
    </button>
  </div>

  <div class="editorWrap" id="editorWrap">
    <div class="editor" id="editBody" contenteditable="true" data-placeholder="–°–º—ã—Å–ª, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞, –ø—Ä–∏–º–µ—Ä‚Ä¶"></div>
  </div>
</div>

<div class="searchOverlay" id="searchOverlay">
  <div class="searchBox" id="searchBox">
    <input class="searchInput" id="searchInput" placeholder="–ù–∞–π—Ç–∏ —è–¥—Ä–æ/–º—ã—Å–ª—å‚Ä¶  (Esc)"/>
    <div class="results" id="results"></div>
  </div>
</div>

<script>
/* =========================================================
   –ü–æ–ª—è –∏ –ü–æ—Ç–æ–∫–∏ v0.9 ‚Äî –ø—Ä–∞–≤–∫–∏ –∏–∑ —Ç–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   1) iPad/—Ç–µ–ª–µ—Ñ–æ–Ω: –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Ç–∞–ø—ã/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ + pinch zoom
   2) –ü–ê–ù: –≤–æ–∑–≤—Ä–∞—Ç ‚Äú—Å—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏‚Äù (wheel down) + —Ñ–æ–Ω –õ–ö–ú
   3) –ó—É–º: —Ä–∞—Å—à–∏—Ä–µ–Ω—ã –ø—Ä–µ–¥–µ–ª—ã (–¥–∞–ª–µ–∫–æ/–±–ª–∏–∑–∫–æ)
   4) –õ–ö–ú –ø–æ –º—ã—Å–ª–∏ –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä (—Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ)
      –†–µ–¥–∞–∫—Ç–æ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è: –ü–ö–ú / –¥–æ–ª–≥–∏–π —Ç–∞–ø / –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º—ã—Å–ª–∏
   5) –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
      - –ø—Ä–µ–¥–∏–∫—Ç-–ø–æ–∑–∏—Ü–∏—è (—Å–ø—Ä–∞–≤–∞ –∏ –æ—Ç—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∞ –ø–æ –∫—Ä—É–≥—É)
      - –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (–∑–∞–∫—Ä—ã—Ç—å/—É–¥–∞–ª–∏—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É)
      - —Ä–µ—Å–∞–π–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (–∞ –Ω–µ ‚Äú–≤–Ω–µ—à–Ω–µ–π —Ä–∞–º–∫–∏‚Äù) + –º–æ–∂–Ω–æ —Ä–µ—Å–∞–π–∑–∏—Ç—å –ø–∞–Ω–µ–ª—å
   6) –°–≤–µ—á–µ–Ω–∏–µ: ‚Äú–æ–¥–Ω–∞ –¥—ã–º–∫–∞‚Äù, –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, –±–µ–∑ –∫–æ–ª–µ—Ü-–æ–±–≤–æ–¥–æ–∫
      + –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è –ø—Ä–∏ –∑—É–º–µ (—Ç–æ–ª—â–∏–Ω–∞/–¥—ã–º–∫–∞ –Ω–µ ‚Äú—Å–∫–∞—á–µ—Ç‚Äù)
   7) –ö–æ–Ω—Ç—Ä–∞—Å—Ç: —è–¥—Ä–∞ –∏ –º—ã—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ (–±–µ–∑ ‚Äú–º—É—Ç–Ω–æ—Å—Ç–∏‚Äù)
   8) –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞–∑–≤–∞–Ω–∏—è: –ø–æ —Å–ª–æ–≤–∞–º, –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ –æ–¥–Ω–æ–π –±—É–∫–≤—ã
   9) –°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É (collapse)
   10) –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏: Ctrl/‚åò-–∫–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ + –∫–Ω–æ–ø–∫–∞ üîó
   11) –ê–≤—Ç–æ-—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–¥–µ–∏ –æ—Ç: —á–∏—Å–ª–∞ –ø–æ—Ç–æ–º–∫–æ–≤ + –æ–±—ä—ë–º–∞ —Ç–µ–∫—Å—Ç–∞ (–≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ)
   12) –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ ‚Äú—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è‚Äù)
========================================================= */

const canvas = document.getElementById("field");
const ctx = canvas.getContext("2d");

const elToggle = document.getElementById("modeToggle");

const elHelpBtn = document.getElementById("helpBtn");
const elHelpPop = document.getElementById("helpPop");
const elExportBtn = document.getElementById("exportBtn");
const elImportInput = document.getElementById("importInput");

const elPanel = document.getElementById("panel");
const elPanelClose = document.getElementById("panelClose");
const elPanelMeta = document.getElementById("panelMeta");
const elEditTitle = document.getElementById("editTitle");
const elEditBody  = document.getElementById("editBody");
const elEditorWrap = document.getElementById("editorWrap");
const elBtnDelete = document.getElementById("btnDelete");
const elBtnCollapse = document.getElementById("btnCollapse");
const elPanelDrag = document.getElementById("panelDrag");

const elSearchOverlay = document.getElementById("searchOverlay");
const elSearchBox = document.getElementById("searchBox");
const elSearchInput = document.getElementById("searchInput");
const elResults = document.getElementById("results");

const bBold   = document.getElementById("bBold");
const bItalic = document.getElementById("bItalic");
const bUnder  = document.getElementById("bUnder");
const bLeft   = document.getElementById("bLeft");
const bCenter = document.getElementById("bCenter");
const bRight  = document.getElementById("bRight");
const bLink   = document.getElementById("bLink");

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function rand(min,max){ return min + Math.random()*(max-min); }
function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

/* ---------- –†–µ–∂–∏–º ---------- */
let mode = "deep"; // deep | focus

/* ---------- –ö–∞–º–µ—Ä–∞ ---------- */
let view = { x: 0, y: 0, z: 1.0 };

/* ---------- DPI ---------- */
let w=0,h=0,cx=0,cy=0,DPR=1;
function resize(){
  DPR = clamp(window.devicePixelRatio||1, 1, 2);
  w = Math.floor(window.innerWidth);
  h = Math.floor(window.innerHeight);
  canvas.width  = Math.floor(w*DPR);
  canvas.height = Math.floor(h*DPR);
  canvas.style.width = w+"px";
  canvas.style.height = h+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
  cx = w/2; cy = h/2;

  syncUITheme();
  initParticles();

  if(elPanel.classList.contains("open")) positionPanelRightOfSelected();
}
window.addEventListener("resize", resize);

/* ---------- –î–∞–Ω–Ω—ã–µ ---------- */
const STORAGE_KEY = "fields_flows_v09";
let state = { cores: [], nodes: [] };
let selected = null; // {type:'core'|'node', id:...}

/* –ø—É–ª—å—Å—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è */
let pulses = []; // {type,id,t0}

/* –¥—ã–º–∫–∞-—Å–≤–µ—á–µ–Ω–∏–µ (—Ö–∞–æ—Å) */
const glowSeed = new Map(); // id -> {a,b,c}
function ensureGlow(id){
  if(glowSeed.has(id)) return glowSeed.get(id);
  const s = { a: rand(0,Math.PI*2), b: rand(0,Math.PI*2), c: rand(0,Math.PI*2) };
  glowSeed.set(id, s);
  return s;
}

/* ---------- –°–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É ---------- */
function isCollapsed(sel){
  const obj = sel?.type==="core" ? getCore(sel.id) : getNode(sel.id);
  return !!obj?.collapsed;
}
function toggleCollapseSelected(){
  const obj = getSelectedObj();
  if(!obj || !selected) return;
  obj.collapsed = !obj.collapsed;
  save();
}

/* ---------- Auto-size ---------- */
function textScore(obj){
  const t = (obj.title || "").trim();
  const b = stripHtml(obj.bodyHtml || "");
  const len = t.length + b.length;
  return Math.min(800, len);
}
function childCountFor(id, type){
  // —Å—á–∏—Ç–∞–µ–º –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã—Ö)
  if(type==="core"){
    const start = state.nodes.filter(n => n.coreId===id).map(n=>n.id);
    return start.length;
  }
  // node
  const toVisit = [id];
  const seen = new Set();
  let count = 0;
  while(toVisit.length){
    const cur = toVisit.pop();
    for(const n of state.nodes){
      if(n.parentType==="node" && n.parentId===cur && !seen.has(n.id)){
        seen.add(n.id);
        count++;
        toVisit.push(n.id);
      }
    }
  }
  return count;
}
function autoRadius(obj, type){
  // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–≥–¥–∞-—Ç–æ ‚Äú—Ä—É—á–∫–∞–º–∏‚Äù –º–µ–Ω—è–ª ‚Äî –æ—Å—Ç–∞–≤–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å (–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ)
  if(obj.rManual != null) return obj.rManual;

  const base = (type==="core") ? 24 : 10;
  const kids = childCountFor(obj.id, type);
  const score = textScore(obj);

  // —Ä–æ—Å—Ç: –¥–µ—Ç–∏ —Å–∏–ª—å–Ω–µ–µ, —Ç–µ–∫—Å—Ç –º—è–≥—á–µ
  const kKids = (type==="core") ? 1.45 : 1.15;
  const kText = (type==="core") ? 0.065 : 0.055;

  const grow =
    Math.sqrt(kids) * 6 * kKids +
    Math.sqrt(score) * kText * 18;

  const r = base + grow;
  const minR = (type==="core") ? 20 : 8;
  const maxR = (type==="core") ? 120 : 70;
  return clamp(r, minR, maxR);
}

/* ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---------- */
function defaultState(){
  const c1 = {id: uid("core"), title:"–û—Å–Ω–æ–≤—ã",   bodyHtml:"", x:-240, y:-80,  hue:210};
  const c2 = {id: uid("core"), title:"–ü—Ä–∞–∫—Ç–∏–∫–∞", bodyHtml:"", x: 180, y:-120, hue:220};
  const c3 = {id: uid("core"), title:"–ò–¥–µ–∏",     bodyHtml:"", x: 120, y: 140, hue:205};
  const c4 = {id: uid("core"), title:"–õ–∏—á–Ω–æ–µ",   bodyHtml:"", x:-160, y: 160, hue:230};
  return { cores:[c1,c2,c3,c4], nodes:[] };
}

/* ---------- Load/Save + Export/Import ---------- */
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      state = defaultState();
      view.x = cx; view.y = cy; view.z = 1.0;
      save();
      return;
    }
    state = JSON.parse(raw);
    if(!state || !Array.isArray(state.cores) || !Array.isArray(state.nodes)){
      state = defaultState();
    }
    if(state._view) view = state._view;
    else { view.x=cx; view.y=cy; view.z=1.0; }
  } catch(e){
    state = defaultState();
    view.x=cx; view.y=cy; view.z=1.0;
  }

  for(const c of state.cores){
    if(c.body && !c.bodyHtml){ c.bodyHtml = escapeHtml(c.body); delete c.body; }
    if(!c.bodyHtml) c.bodyHtml = "";
    ensureGlow(c.id);
  }
  for(const n of state.nodes){
    if(n.body && !n.bodyHtml){ n.bodyHtml = escapeHtml(n.body); delete n.body; }
    if(!n.bodyHtml) n.bodyHtml = "";
    ensureGlow(n.id);
  }
}
function save(){
  state._view = view;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function exportJSON(){
  const payload = { ...state };
  // –≤—ã–∫–∏–¥—ã–≤–∞–µ–º ‚Äú–≤—Ä–µ–º–µ–Ω–Ω—ã–µ‚Äù —à—Ç—É–∫–∏
  delete payload._view;
  const blob = new Blob([JSON.stringify({state: payload, view}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "fields-and-flows.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJSON(file){
  const text = await file.text();
  const data = JSON.parse(text);
  if(!data || !data.state || !data.view) return;

  const st = data.state;
  if(!Array.isArray(st.cores) || !Array.isArray(st.nodes)) return;

  state = st;
  view = data.view;

  for(const c of state.cores) ensureGlow(c.id);
  for(const n of state.nodes) ensureGlow(n.id);

  save();
  closePanel();
  selected = null;
}

/* ---------- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ---------- */
function worldToScreen(wx, wy){ return { x: (wx*view.z)+view.x, y: (wy*view.z)+view.y }; }
function screenToWorld(sx, sy){ return { x: (sx-view.x)/view.z, y: (sy-view.y)/view.z }; }

/* ---------- UI theme ---------- */
function syncUITheme(){
  const isLight = mode==="focus";
  elToggle.classList.toggle("light", isLight);
  elPanel.classList.toggle("light", isLight);
  elHelpBtn.classList.toggle("light", isLight);
  elHelpPop.classList.toggle("light", isLight);
  elSearchBox.classList.toggle("light", isLight);
}

/* ---------- Help ---------- */
elHelpBtn.addEventListener("click", ()=>{
  elHelpPop.classList.toggle("open");
});
window.addEventListener("pointerdown",(e)=>{
  if(elHelpPop.classList.contains("open")){
    const inPop = elHelpPop.contains(e.target);
    const inBtn = elHelpBtn.contains(e.target);
    if(!inPop && !inBtn) elHelpPop.classList.remove("open");
  }
}, {passive:true});

elExportBtn.addEventListener("click", exportJSON);
elImportInput.addEventListener("change", async ()=>{
  if(elImportInput.files && elImportInput.files[0]){
    await importJSON(elImportInput.files[0]);
    elImportInput.value = "";
  }
});

/* ---------- Particles ---------- */
let particlesFar=[], particlesNear=[];
function makeParticle(layer){
  const isFar = layer==="far";
  const baseSize = isFar ? rand(0.4,1.4) : rand(0.8,2.4);
  return {
    x: rand(0,w), y: rand(0,h),
    vx: isFar ? rand(-0.055,0.055) : rand(-0.12,0.12),
    vy: isFar ? rand(-0.035,0.035) : rand(-0.09,0.09),
    z: rand(0.2,1.0),
    vz: isFar ? rand(-0.00055,0.00055) : rand(-0.0011,0.0011),
    tw: rand(0,Math.PI*2),
    twSpeed: isFar ? rand(0.010,0.022) : rand(0.014,0.030),
    size: baseSize,
    baseAlpha: isFar ? rand(0.10,0.30) : rand(0.09,0.22),
  };
}
function initParticles(){
  const farCount  = Math.round((w*h)/52000);
  const nearCount = Math.round((w*h)/32000);
  particlesFar  = Array.from({length: Math.min(120, Math.max(18, farCount))}, () => makeParticle("far"));
  particlesNear = Array.from({length: Math.min(180, Math.max(26, nearCount))}, () => makeParticle("near"));
}
function drawBackground(t){
  const breathe = (Math.sin(t*0.01)+1)*0.5;
  const grd = ctx.createRadialGradient(
    cx + (mode==="deep" ? (breathe-0.5)*40 : (breathe-0.5)*16),
    cy + (mode==="deep" ? (0.5-breathe)*28 : (0.5-breathe)*12),
    120, cx, cy, Math.max(w,h)
  );
  if(mode==="deep"){
    // –±–æ–ª–µ–µ ‚Äú—Å–æ—á–Ω–æ/–∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ‚Äù
    grd.addColorStop(0, "#101a3a");
    grd.addColorStop(0.55,"#060816");
    grd.addColorStop(1, "#02030a");
  }else{
    grd.addColorStop(0, "#fbfcff");
    grd.addColorStop(0.6,"#eef3ff");
    grd.addColorStop(1, "#e1e9ff");
  }
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,w,h);

  ctx.fillStyle = (mode==="deep") ? "rgba(10,14,28,0.10)" : "rgba(255,255,255,0.10)";
  ctx.fillRect(0,0,w,h);
}
function updateAndDrawParticles(list, layer, t){
  const speedMul = (mode==="deep") ? 1.0 : 1.05;

  // —Å–ø–æ–∫–æ–π–Ω–µ–µ –Ω–∞ —Å–≤–µ—Ç–ª–æ–π, –Ω–æ –Ω–µ ‚Äú–≥—Ä—è–∑—å—é‚Äù
  let r,g,b;
  if(mode==="deep"){ r=170; g=210; b=255; }
  else { r=130; g=150; b=190; }

  for(const p of list){
    p.x += p.vx * speedMul * (0.6+p.z);
    p.y += p.vy * speedMul * (0.6+p.z);
    p.z += p.vz;
    if(p.z<0.15 || p.z>1.15) p.vz *= -1;
    if(p.x<-20) p.x=w+20;
    if(p.x>w+20) p.x=-20;
    if(p.y<-20) p.y=h+20;
    if(p.y>h+20) p.y=-20;

    p.tw += p.twSpeed;
    const twinkle = 0.62 + 0.38*Math.sin(p.tw);

    const alphaBoost = (mode==="deep") ? 1.0 : 0.55;
    const a = Math.min(0.55, (p.baseAlpha*alphaBoost)*twinkle);
    const s = p.size*(0.75+p.z*0.85);

    ctx.fillStyle = `rgba(${r},${g},${b},${a})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,s,0,Math.PI*2);
    ctx.fill();

    const glowA = (mode==="deep") ? (a*0.08) : (a*0.045);
    ctx.fillStyle = `rgba(${r},${g},${b},${glowA})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,s*3.0,0,Math.PI*2);
    ctx.fill();
  }
}

/* ---------- Objects ---------- */
function getCore(id){ return state.cores.find(c=>c.id===id); }
function getNode(id){ return state.nodes.find(n=>n.id===id); }

function isHiddenByCollapse(node){
  // —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–µ–¥–æ–∫ —Å–≤–µ—Ä–Ω—É—Ç
  let cur = node;
  while(cur){
    if(cur.collapsed) return true;
    if(cur.parentType==="core"){
      const c = getCore(cur.parentId);
      return !!c?.collapsed;
    }
    cur = getNode(cur.parentId);
  }
  return false;
}

function getEdges(){
  const edges = [];
  for(const n of state.nodes){
    if(isHiddenByCollapse(n)) continue;

    if(n.parentType==="core"){
      const parentCore = getCore(n.parentId);
      if(parentCore?.collapsed) continue;
      edges.push({aType:"core", aId:n.parentId, bType:"node", bId:n.id});
    }else{
      const parentNode = getNode(n.parentId);
      if(parentNode?.collapsed) continue;
      edges.push({aType:"node", aId:n.parentId, bType:"node", bId:n.id});
    }
  }
  return edges;
}

/* ---------- Text helpers ---------- */
function escapeHtml(s){
  return (s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function stripHtml(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html || "";
  return (tmp.textContent || tmp.innerText || "").trim();
}

/* –ø–µ—Ä–µ–Ω–æ—Å –ù–ê –°–õ–û–í–ê–•, –±–µ–∑ ‚Äú–æ–¥–Ω–æ–π –±—É–∫–≤—ã –Ω–∞ —Å—Ç—Ä–æ–∫–µ‚Äù */
function drawWrappedLabel(text, x, y, maxWidth, lineHeight, maxLines){
  text = (text || "").trim();
  if(!text) return;

  const words = text.split(/\s+/).filter(Boolean);
  if(words.length===0) return;

  const lines = [];
  let line = "";

  for(const w of words){
    const test = line ? (line + " " + w) : w;
    if(ctx.measureText(test).width <= maxWidth){
      line = test;
    }else{
      if(line) lines.push(line);
      line = w;
      if(lines.length === maxLines) break;
    }
  }
  if(lines.length < maxLines && line) lines.push(line);

  // –µ—Å–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî —Ç—Ä–æ–µ—Ç–æ—á–∏–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ
  const fullJoined = words.join(" ");
  const curJoined = lines.join(" ");
  if(curJoined.length < fullJoined.length && lines.length){
    let last = lines[lines.length-1];
    const ell = "‚Ä¶";
    while(ctx.measureText(last + ell).width > maxWidth && last.length>0){
      last = last.slice(0, -1);
    }
    lines[lines.length-1] = (last.length ? last + ell : ell);
  }

  // –∑–∞–ø—Ä–µ—Ç ‚Äú–æ–¥–Ω–æ–π –±—É–∫–≤—ã‚Äù –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤—ã—à–ª–æ)
  if(lines.length>=2){
    const last = lines[lines.length-1].replace("‚Ä¶","").trim();
    if(last.length===1){
      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º 1 —Å–ª–æ–≤–æ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
      const prev = lines[lines.length-2];
      const parts = prev.split(" ");
      if(parts.length>=2){
        const moved = parts.pop();
        lines[lines.length-2] = parts.join(" ");
        lines[lines.length-1] = moved + (lines[lines.length-1].includes("‚Ä¶") ? "‚Ä¶" : "");
      }
    }
  }

  for(let i=0;i<lines.length;i++){
    ctx.fillText(lines[i], x, y + i*lineHeight);
  }
}

/* ---------- Rendering ---------- */
function hsl(h,s,l,a=1){ return `hsla(${h},${s}%,${l}%,${a})`; }

function drawEdges(t){
  const edges = getEdges();
  const baseLine = (mode==="deep") ? "rgba(150,190,255,0.26)" : "rgba(50,70,120,0.20)";
  ctx.lineCap = "round";

  for(const E of edges){
    const A = (E.aType==="core") ? getCore(E.aId) : getNode(E.aId);
    const B = getNode(E.bId);
    if(!A || !B) continue;

    const As = worldToScreen(A.x, A.y);
    const Bs = worldToScreen(B.x, B.y);

    const seed = ((A.x*0.013 + A.y*0.017 + B.x*0.019 + B.y*0.011) % 1000);
    const strong = (E.aType==="node") ? 1.45 : 1.0;

    const sway =
      strong * (9 * Math.sin(t*0.018 + seed) +
               6 * Math.sin(t*0.007 + seed*0.7) +
               4 * Math.sin(t*0.011 + seed*1.3));

    ctx.strokeStyle = baseLine;
    ctx.lineWidth = (E.aType==="node") ? 1.35 : 1.55;

    ctx.beginPath();
    ctx.moveTo(As.x, As.y);
    ctx.quadraticCurveTo((As.x+Bs.x)/2 + sway, (As.y+Bs.y)/2 - sway, Bs.x, Bs.y);
    ctx.stroke();
  }
}

/* –ø—É–ª—å—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è */
function addPulse(sel){
  pulses.push({type: sel.type, id: sel.id, t0: performance.now()});
}
function drawPulses(now){
  const life = 360;
  pulses = pulses.filter(p => (now - p.t0) < life);

  for(const p of pulses){
    const obj = (p.type==="core") ? getCore(p.id) : getNode(p.id);
    if(!obj) continue;

    const s = worldToScreen(obj.x, obj.y);
    const baseR = (p.type==="core") ? autoRadius(obj,"core") : autoRadius(obj,"node");
    const r = baseR * view.z;

    const k = (now - p.t0) / life;
    const ringR = r + 12*view.z + k * (20*view.z);
    const alpha = (1-k) * 0.33;

    ctx.strokeStyle = (mode==="deep") ? `rgba(200,235,255,${alpha})` : `rgba(55,90,130,${alpha*0.85})`;
    ctx.lineWidth = 2.0;
    ctx.beginPath();
    ctx.arc(s.x, s.y, ringR, 0, Math.PI*2);
    ctx.stroke();
  }
}

/* –î–´–ú–ö–ê-—Å–≤–µ—á–µ–Ω–∏–µ: –æ–¥–Ω–∞ –º—è–≥–∫–∞—è –∞—É—Ä–∞ –±–µ–∑ –∫–æ–ª–µ—Ü, –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è
   –í–∞–∂–Ω–æ: –Ω–µ ‚Äú–ø—Ä–∏–≤—è–∑–∞–Ω–∞‚Äù –∫ view.z —Ç–∞–∫, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ –Ω–∞ –ª—é–±—ã—Ö –∑—É–º–∞—Ö */
function drawHaze(posx, posy, r, id, t, hue){
  const s = ensureGlow(id);

  // –¥—ã—Ö–∞–Ω–∏–µ (—Ö–∞–æ—Ç–∏—á–Ω–æ–µ)
  const a = Math.sin(t*0.020 + s.a);
  const b = Math.sin(t*0.013 + s.b);
  const c = Math.sin(t*0.008 + s.c);
  const osc = (a*0.55 + b*0.30 + c*0.20); // -..+

  // ‚Äú—Ç–æ–ª—â–∏–Ω–∞ –¥—ã–º–∫–∏‚Äù –ø–æ –ø–∏–∫—Å–µ–ª—è–º (–ø–æ—á—Ç–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è)
  const px = (mode==="deep") ? 18 : 14;
  const haze = px + osc*6;

  const alpha = (mode==="deep") ? 0.42 : 0.30;

  ctx.save();
  ctx.globalCompositeOperation = "lighter";
  ctx.shadowColor = hsl(hue, 92, 70, alpha);
  ctx.shadowBlur = haze;
  ctx.fillStyle = hsl(hue, 92, 68, alpha*0.16);

  // —Ä–∏—Å—É–µ–º ‚Äú–∫–ª—è–∫—Å—É‚Äù —á—É—Ç—å –±–æ–ª—å—à–µ –∫—Ä—É–≥–∞, –Ω–æ —ç—Ç–æ –Ω–µ –∫–æ–ª—å—Ü–∞ ‚Äî —ç—Ç–æ shadowBlur
  ctx.beginPath();
  ctx.arc(posx, posy, r + 1.5, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function drawCore(c, t){
  const pos = worldToScreen(c.x, c.y);
  const rWorld = autoRadius(c,"core");
  const r = rWorld * view.z;

  const hue = c.hue ?? 210;
  const isSel = selected && selected.type==="core" && selected.id===c.id;

  // –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å (–Ω–∏–∫–∞–∫–∏—Ö ‚Äú–º—É—Ç–Ω—ã—Ö‚Äù)
  const fill = (mode==="deep") ? hsl(hue, 92, 64, 0.96) : hsl(hue, 78, 50, 0.95);

  // –¥—ã–º–∫–∞
  drawHaze(pos.x, pos.y, r, c.id, t, hue);

  // —Ç–µ–ª–æ
  ctx.fillStyle = fill;
  ctx.beginPath();
  ctx.arc(pos.x, pos.y, r, 0, Math.PI*2);
  ctx.fill();

  // –ª—ë–≥–∫–∏–π –∫–æ–Ω—Ç—É—Ä –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
  ctx.strokeStyle = (mode==="deep") ? "rgba(255,255,255,0.10)" : "rgba(0,0,0,0.10)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.arc(pos.x, pos.y, r, 0, Math.PI*2);
  ctx.stroke();

  if(isSel){
    ctx.strokeStyle = (mode==="deep") ? "rgba(220,245,255,0.24)" : "rgba(30,60,110,0.18)";
    ctx.lineWidth = 2.2;
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, r+2.5, 0, Math.PI*2);
    ctx.stroke();
  }

  // label
  const label = (c.title ?? "").trim();
  if(label){
    ctx.font = `${Math.max(12, 12*view.z)}px Inter, system-ui`;
    ctx.fillStyle = (mode==="deep") ? "rgba(234,242,255,0.88)" : "rgba(18,22,35,0.78)";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    const maxW = Math.max(140, r*3.6);
    drawWrappedLabel(label, pos.x, pos.y + r + 10, maxW, Math.max(14, 14*view.z), 2);
  }

  // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ‚Äú—Å–≤–µ—Ä–Ω—É—Ç–æ‚Äù
  if(c.collapsed){
    ctx.fillStyle = (mode==="deep") ? "rgba(234,242,255,0.75)" : "rgba(18,22,35,0.65)";
    ctx.font = `${Math.max(12, 12*view.z)}px Inter, system-ui`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("‚ñ∏", pos.x, pos.y);
  }
}

function drawNode(n, t){
  if(isHiddenByCollapse(n)) return;

  const pos = worldToScreen(n.x, n.y);
  const rWorld = autoRadius(n,"node");
  const r = rWorld * view.z;

  const hue = n.hue ?? 205;
  const isSel = selected && selected.type==="node" && selected.id===n.id;

  // –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å
  const fill = (mode==="deep") ? hsl(hue, 92, 68, 0.96) : hsl(hue, 78, 52, 0.95);

  drawHaze(pos.x, pos.y, r, n.id, t, hue);

  ctx.fillStyle = fill;
  ctx.beginPath();
  ctx.arc(pos.x, pos.y, r, 0, Math.PI*2);
  ctx.fill();

  ctx.strokeStyle = (mode==="deep") ? "rgba(255,255,255,0.10)" : "rgba(0,0,0,0.10)";
  ctx.lineWidth = 1.1;
  ctx.beginPath();
  ctx.arc(pos.x, pos.y, r, 0, Math.PI*2);
  ctx.stroke();

  if(isSel){
    ctx.strokeStyle = (mode==="deep") ? "rgba(220,245,255,0.22)" : "rgba(30,60,110,0.16)";
    ctx.lineWidth = 2.0;
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, r+2.0, 0, Math.PI*2);
    ctx.stroke();
  }

  const label = (n.title ?? "").trim();
  if(label){
    ctx.font = `${Math.max(11, 11*view.z)}px Inter, system-ui`;
    ctx.fillStyle = (mode==="deep") ? "rgba(234,242,255,0.84)" : "rgba(18,22,35,0.72)";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    const maxW = Math.max(130, r*3.4);
    drawWrappedLabel(label, pos.x, pos.y + r + 8, maxW, Math.max(13, 13*view.z), 2);
  }

  if(n.collapsed){
    ctx.fillStyle = (mode==="deep") ? "rgba(234,242,255,0.75)" : "rgba(18,22,35,0.65)";
    ctx.font = `${Math.max(11, 11*view.z)}px Inter, system-ui`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("‚ñ∏", pos.x, pos.y);
  }
}

function drawWorld(t){
  drawEdges(t);
  for(const c of state.cores) drawCore(c, t);
  for(const n of state.nodes) drawNode(n, t);

  if(selected){
    if(selected.type==="core"){
      const c = getCore(selected.id); if(c) drawCore(c, t);
    }else{
      const n = getNode(selected.id); if(n) drawNode(n, t);
    }
  }

  drawPulses(performance.now());
}

/* ---------- Hit-test (—É—á–∏—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ-—Ä–∞–¥–∏—É—Å) ---------- */
function hitTest(sx, sy){
  for(let i=state.nodes.length-1;i>=0;i--){
    const n = state.nodes[i];
    if(isHiddenByCollapse(n)) continue;
    const p = worldToScreen(n.x, n.y);
    const r = autoRadius(n,"node") * view.z;
    const dx = sx - p.x, dy = sy - p.y;
    if(dx*dx + dy*dy <= (r+10)*(r+10)) return {type:"node", id:n.id};
  }
  for(let i=state.cores.length-1;i>=0;i--){
    const c = state.cores[i];
    const p = worldToScreen(c.x, c.y);
    const r = autoRadius(c,"core") * view.z;
    const dx = sx - p.x, dy = sy - p.y;
    if(dx*dx + dy*dy <= (r+12)*(r+12)) return {type:"core", id:c.id};
  }
  return null;
}

/* ---------- Creation ---------- */
function createCoreAtWorld(wx, wy){
  const hue = Math.round(rand(190, 235));
  const c = {id: uid("core"), title:"–ù–æ–≤—ã–π –º–∏—Ä", bodyHtml:"", x: wx, y: wy, hue, collapsed:false};
  state.cores.push(c);
  ensureGlow(c.id);
  save();
  selected = {type:"core", id:c.id};
  addPulse(selected);
}

function createNode(parentType, parentId, coreId){
  const base = parentType==="core" ? getCore(parentId) : getNode(parentId);
  if(!base) return;

  // –µ—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å –±—ã–ª —Å–≤–µ—Ä–Ω—É—Ç ‚Äî —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º (–∏–Ω–∞—á–µ ‚Äú—Å–æ–∑–¥–∞–ª–æ—Å—å, –Ω–æ –Ω–µ –≤–∏–¥–Ω–æ‚Äù)
  base.collapsed = false;

  const angle = rand(0, Math.PI*2);
  const dist = rand(90, 145);
  const hueBase = (parentType==="core") ? (getCore(parentId)?.hue ?? 210) : (getNode(parentId)?.hue ?? 205);
  const hue = clamp(hueBase + rand(-18,18), 0, 360);

  const n = {
    id: uid("node"),
    coreId,
    parentType,
    parentId,
    title: "–ú—ã—Å–ª—å",
    bodyHtml: "",
    x: base.x + Math.cos(angle)*dist,
    y: base.y + Math.sin(angle)*dist,
    hue,
    collapsed:false
  };
  state.nodes.push(n);
  ensureGlow(n.id);
  save();
  selected = {type:"node", id:n.id};
  addPulse(selected);
}

/* ---------- Panel ---------- */
function openPanel(){
  elPanel.classList.add("open");
  refreshPanelFields();
}
function closePanel(){
  elPanel.classList.remove("open");
}
elPanelClose.onclick = closePanel;

function getSelectedObj(){
  if(!selected) return null;
  return selected.type==="core" ? getCore(selected.id) : getNode(selected.id);
}

function refreshPanelFields(){
  if(!selected) return;
  const obj = getSelectedObj();
  if(!obj) return;

  if(selected.type==="core"){
    const count = state.nodes.filter(n=>n.coreId===obj.id).length;
    elPanelMeta.textContent = `–Ø–¥—Ä–æ ‚Ä¢ –º—ã—Å–ª–µ–π: ${count} ‚Ä¢ ${obj.collapsed ? "–≤–µ—Ç–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞" : "–≤–µ—Ç–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞"}`;
  }else{
    const parent = obj.parentType==="core" ? getCore(obj.parentId) : getNode(obj.parentId);
    const pTitle = parent?.title ?? "‚Äî";
    elPanelMeta.textContent = `–ú—ã—Å–ª—å ‚Ä¢ –≤–Ω—É—Ç—Ä–∏: ${pTitle} ‚Ä¢ ${obj.collapsed ? "–≤–µ—Ç–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞" : "–≤–µ—Ç–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞"}`;
  }

  elEditTitle.value = obj.title ?? "";
  elEditBody.innerHTML  = obj.bodyHtml ?? "";
}

/* –∞–≤—Ç–æ—Å–µ–π–≤ */
function scheduleEditSave(){
  clearTimeout(scheduleEditSave._t);
  scheduleEditSave._t = setTimeout(()=>{
    if(!selected) return;
    const obj = getSelectedObj();
    if(!obj) return;

    obj.title = elEditTitle.value;
    obj.bodyHtml = elEditBody.innerHTML;

    save();
  }, 120);
}
elEditTitle.addEventListener("input", scheduleEditSave);
elEditBody.addEventListener("input", scheduleEditSave);

/* delete */
function deleteSelected(){
  if(!selected) return;

  if(selected.type==="core"){
    const id = selected.id;
    state.nodes = state.nodes.filter(n=>n.coreId!==id);
    state.cores = state.cores.filter(c=>c.id!==id);
  }else{
    const id = selected.id;
    const toDelete = new Set([id]);
    let changed = true;
    while(changed){
      changed = false;
      for(const n of state.nodes){
        if(n.parentType==="node" && toDelete.has(n.parentId) && !toDelete.has(n.id)){
          toDelete.add(n.id);
          changed = true;
        }
      }
    }
    state.nodes = state.nodes.filter(n=>!toDelete.has(n.id));
  }

  selected = null;
  save();
  closePanel();
}
elBtnDelete.onclick = deleteSelected;

elBtnCollapse.onclick = ()=>{
  toggleCollapseSelected();
  refreshPanelFields();
};

/* —á—Ç–æ–±—ã drag –ø–∞–Ω–µ–ª–∏ –Ω–µ ‚Äú–≥–ª–æ—Ç–∞–ª‚Äù –∫–Ω–æ–ø–∫–∏ */
for(const btn of [elPanelClose, elBtnDelete, elBtnCollapse]){
  btn.addEventListener("pointerdown", (e)=>{ e.stopPropagation(); }, {passive:true});
}

/* ---------- Rich text ---------- */
function rt(cmd, val=null){
  document.execCommand(cmd, false, val);
  elEditBody.focus();
  scheduleEditSave();
}
bBold.onclick   = ()=> rt("bold");
bItalic.onclick = ()=> rt("italic");
bUnder.onclick  = ()=> rt("underline");
bLeft.onclick   = ()=> rt("justifyLeft");
bCenter.onclick = ()=> rt("justifyCenter");
bRight.onclick  = ()=> rt("justifyRight");

bLink.onclick = ()=>{
  const url = prompt("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É (https://...)");
  if(!url) return;
  rt("createLink", url);
};

/* –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏: Ctrl/‚åò-–∫–ª–∏–∫ */
elEditBody.addEventListener("click",(e)=>{
  const a = e.target?.closest?.("a");
  if(!a) return;
  if(e.ctrlKey || e.metaKey){
    e.preventDefault();
    window.open(a.href, "_blank");
  }
});

/* ---------- Search ---------- */
function openSearch(){
  elSearchOverlay.classList.add("open");
  elSearchInput.value = "";
  renderResults([]);
  elSearchInput.focus();
}
function closeSearch(){ elSearchOverlay.classList.remove("open"); }

function renderResults(items){
  elResults.innerHTML="";
  if(items.length===0){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<span style="opacity:.55">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å‚Ä¶</span><span class="tag">Esc</span>`;
    elResults.appendChild(div);
    return;
  }
  for(const it of items){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<span>${escapeHtml(it.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</span><span class="tag">${it.type==="core"?"—è–¥—Ä–æ":"–º—ã—Å–ª—å"}</span>`;
    div.onclick=()=>{
      closeSearch();
      selected = {type: it.type, id: it.id};
      addPulse(selected);
      focusToSelected(true); // –ø–æ–∏—Å–∫ = —Å—Ä–∞–∑—É —Ñ–æ–∫—É—Å + —Ä–µ–¥–∞–∫—Ç–æ—Ä
    };
    elResults.appendChild(div);
  }
}
function searchItems(q){
  q=(q||"").trim().toLowerCase();
  if(!q) return [];
  const res=[];
  for(const c of state.cores){
    const hay=((c.title||"")+" "+stripHtml(c.bodyHtml||"")).toLowerCase();
    if(hay.includes(q)) res.push({type:"core",id:c.id,title:c.title});
  }
  for(const n of state.nodes){
    const hay=((n.title||"")+" "+stripHtml(n.bodyHtml||"")).toLowerCase();
    if(hay.includes(q)) res.push({type:"node",id:n.id,title:n.title});
  }
  return res.slice(0,20);
}
elSearchInput.addEventListener("input", ()=>renderResults(searchItems(elSearchInput.value)));
elSearchOverlay.addEventListener("click", (e)=>{ if(e.target===elSearchOverlay) closeSearch(); });

/* ---------- Keyboard ---------- */
function isTypingTarget(el){
  if(!el) return false;
  const tag = (el.tagName||"").toLowerCase();
  return tag==="input" || tag==="textarea" || el.isContentEditable;
}
window.addEventListener("keydown",(e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){
    e.preventDefault();
    openSearch();
    return;
  }
  if(e.key==="Escape"){
    if(elSearchOverlay.classList.contains("open")) closeSearch();
    return;
  }
  if((e.key==="Delete" || e.key==="Backspace") && !isTypingTarget(document.activeElement)){
    if(selected){
      e.preventDefault();
      deleteSelected();
    }
    return;
  }

  // —Ä—É—á–Ω–æ–π override —Ä–∞–∑–º–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–µ–º)
  if(!isTypingTarget(document.activeElement) && selected){
    if(e.key==="[" || e.key==="]"){
      e.preventDefault();
      const obj = getSelectedObj();
      if(!obj) return;
      const cur = (obj.rManual != null) ? obj.rManual : autoRadius(obj, selected.type);
      obj.rManual = clamp(cur + (e.key==="]" ? +2 : -2), selected.type==="core" ? 20 : 8, selected.type==="core" ? 160 : 90);
      save();
      return;
    }
  }
});

/* ---------- Mode toggle ---------- */
elToggle.onclick = ()=>{
  mode = (mode==="deep") ? "focus" : "deep";
  syncUITheme();
};

/* ---------- Panel position: –≤—Å–µ–≥–¥–∞ —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫—Ä—É–≥–∞ + —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥—É ---------- */
function getObjScreenRadius(sel, zOverride=null){
  const obj = sel?.type==="core" ? getCore(sel.id) : getNode(sel.id);
  if(!obj) return 30;
  const zr = (zOverride==null) ? view.z : zOverride;
  const rw = autoRadius(obj, sel.type);
  return rw * zr;
}

function positionPanelRightOfSelected(opts={}){
  if(!selected) return;
  const obj = getSelectedObj();
  if(!obj) return;

  const mobile = window.innerWidth < 520;
  if(mobile){
    elPanel.style.left = "12px";
    elPanel.style.top = "";
    elPanel.style.right = "";
    elPanel.style.bottom = "12px";
    elPanel.style.width = "calc(100vw - 24px)";
    elPanel.style.height = "auto";
    return;
  }

  elPanel.style.bottom = "";
  elPanel.style.width = elPanel.getBoundingClientRect().width ? (elPanel.getBoundingClientRect().width + "px") : "360px";

  const p = opts.predictedPos || worldToScreen(obj.x, obj.y);
  const zPred = (opts.predictedZ != null) ? opts.predictedZ : view.z;

  // —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏ (–ø–æ—Å–ª–µ —Ä–µ—Å–∞–π–∑–∞!)
  const rect = elPanel.getBoundingClientRect();
  const rectW = rect.width || 360;
  const rectH = rect.height || 320;

  const r = getObjScreenRadius(selected, zPred);
  const gap = 22;

  // —Å–ø—Ä–∞–≤–∞
  let left = p.x + r + gap;

  // –≤–∞–∂–Ω–æ–µ: –í–ï–†–¢–ò–ö–ê–õ–¨–ù–ê–Ø –¶–ï–ù–¢–†–û–í–ö–ê –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫—Ä—É–≥–∞
  let top  = p.y - rectH*0.50;

  if(left + rectW > window.innerWidth - 12){
    left = p.x - r - gap - rectW;
  }

  left = clamp(left, 12, window.innerWidth - 12 - rectW);
  top  = clamp(top, 12, window.innerHeight - 12 - rectH);

  elPanel.style.left = Math.round(left) + "px";
  elPanel.style.top  = Math.round(top) + "px";
}

/* panel drag (desktop) */
let dragPanel = {on:false, ox:0, oy:0};
elPanelDrag.addEventListener("pointerdown",(e)=>{
  if(window.innerWidth < 520) return;
  // –µ—Å–ª–∏ –∂–º–µ–º –ø–æ –∫–Ω–æ–ø–∫–∞–º ‚Äî –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º drag
  if(e.target.closest("button")) return;

  dragPanel.on = true;
  const rect = elPanel.getBoundingClientRect();
  dragPanel.ox = e.clientX - rect.left;
  dragPanel.oy = e.clientY - rect.top;
  elPanel.setPointerCapture(e.pointerId);
});
elPanelDrag.addEventListener("pointermove",(e)=>{
  if(!dragPanel.on) return;
  const rect = elPanel.getBoundingClientRect();
  const panelW = rect.width;
  const panelH = rect.height;

  let left = e.clientX - dragPanel.ox;
  let top  = e.clientY - dragPanel.oy;

  left = clamp(left, 12, window.innerWidth - 12 - panelW);
  top  = clamp(top, 12, window.innerHeight - 12 - panelH);

  elPanel.style.left = left+"px";
  elPanel.style.top  = top+"px";
});
elPanelDrag.addEventListener("pointerup",(e)=>{
  dragPanel.on=false;
  try{ elPanel.releasePointerCapture(e.pointerId); }catch(_){}
});

/* –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å —Ä–µ—Å–∞–π–∑—è—Ç ‚Äî —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç–∫—Ä–∞–Ω–∞ */
const ro = new ResizeObserver(()=> {
  if(elPanel.classList.contains("open")) positionPanelRightOfSelected();
});
ro.observe(elPanel);

/* ---------- Pointer engine (–º—ã—à—å/—Ç–∞—á –æ–¥–∏–Ω–∞–∫–æ–≤–æ) ---------- */
const pointers = new Map(); // id -> {x,y, startX,startY, time, hitAtStart}
let gesture = {
  mode: "none", // none | pan | dragObject | pinch | midpan | longpress
  dragSel: null,
  moved: false,
  downAt: 0,
  longPressTimer: null,
  lastTapAt: 0,
  lastTapX: 0,
  lastTapY: 0
};

const DRAG_THRESHOLD = 6;
const DOUBLE_TAP_MS = 320;
const DOUBLE_TAP_PX = 22;
const LONG_PRESS_MS = 420;

function cancelLongPress(){
  if(gesture.longPressTimer){
    clearTimeout(gesture.longPressTimer);
    gesture.longPressTimer = null;
  }
}

function pointerDown(e){
  // –Ω–µ –º–µ—à–∞–µ–º UI
  if(elPanel.contains(e.target) || elHelpPop.contains(e.target) || elSearchOverlay.contains(e.target)) return;

  canvas.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, {x:e.clientX, y:e.clientY, startX:e.clientX, startY:e.clientY, time: performance.now(), hitAtStart: hitTest(e.clientX,e.clientY)});
  gesture.moved = false;

  // middle mouse pan
  if(e.pointerType==="mouse" && e.button===1){
    gesture.mode = "midpan";
    cancelLongPress();
    e.preventDefault();
    return;
  }

  // –ª–µ–≤—ã–π –∫–ª–∏–∫/—Ç–∞–ø
  if(e.pointerType==="mouse" && e.button!==0){
    return;
  }

  const pcount = pointers.size;

  // pinch start
  if(pcount===2){
    gesture.mode = "pinch";
    cancelLongPress();
    const pts = [...pointers.values()];
    gesture.pinch = {
      startDist: Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y),
      startZ: view.z,
      startMid: { x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2 },
      startView: { x:view.x, y:view.y }
    };
    return;
  }

  // single pointer
  const hit = pointers.get(e.pointerId).hitAtStart;

  // –õ–ö–ú/—Ç–∞–ø: —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –ë–ï–ó –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏
  if(hit){
    selected = hit;
    addPulse(selected);
    gesture.mode = "dragObject";
    gesture.dragSel = hit;
  }else{
    selected = null;
    closePanel();
    gesture.mode = "pan";
    gesture.dragSel = null;
  }

  // long press (—Ç–∞—á/–ø–µ–Ω)
  cancelLongPress();
  if(e.pointerType!=="mouse"){
    gesture.longPressTimer = setTimeout(()=>{
      const st = pointers.get(e.pointerId);
      if(!st) return;
      const moved = Math.hypot(st.x-st.startX, st.y-st.startY) > DRAG_THRESHOLD;
      if(moved) return;
      if(st.hitAtStart){
        selected = st.hitAtStart;
        addPulse(selected);
        focusToSelected(true); // –¥–æ–ª–≥–∏–π —Ç–∞–ø = –ø–æ–¥–ª–µ—Ç + —Ä–µ–¥–∞–∫—Ç–æ—Ä
      }
    }, LONG_PRESS_MS);
  }
}

function pointerMove(e){
  if(!pointers.has(e.pointerId)) return;

  const p = pointers.get(e.pointerId);
  p.x = e.clientX;
  p.y = e.clientY;

  const movedAny = Math.hypot(p.x-p.startX, p.y-p.startY) > DRAG_THRESHOLD;
  if(movedAny) gesture.moved = true;
  if(gesture.moved) cancelLongPress();

  // pinch
  if(pointers.size===2 && gesture.mode==="pinch"){
    const pts = [...pointers.values()];
    const dist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
    const mid = { x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2 };

    const before = screenToWorld(mid.x, mid.y);
    const factor = dist / Math.max(10, gesture.pinch.startDist);

    view.z = clamp(gesture.pinch.startZ * factor, 0.01, 30.0);

    const after = screenToWorld(mid.x, mid.y);
    view.x += (after.x-before.x)*view.z;
    view.y += (after.y-before.y)*view.z;

    save();
    return;
  }

  // pan / midpan
  if(gesture.mode==="pan" || gesture.mode==="midpan"){
    // –¥–≤–∏–≥–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –¥–µ–ª—å—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ pointerId
    const dx = e.movementX || (p.x - (p.prevX ?? p.x));
    const dy = e.movementY || (p.y - (p.prevY ?? p.y));
    p.prevX = p.x; p.prevY = p.y;

    view.x += dx;
    view.y += dy;
    save();
    return;
  }

  // drag object
  if(gesture.mode==="dragObject" && gesture.dragSel && pointers.size===1){
    const dx = e.movementX || (p.x - (p.prevX ?? p.x));
    const dy = e.movementY || (p.y - (p.prevY ?? p.y));
    p.prevX = p.x; p.prevY = p.y;

    const worldDelta = {x: dx/view.z, y: dy/view.z};
    if(gesture.dragSel.type==="core"){
      const c=getCore(gesture.dragSel.id);
      if(c){ c.x+=worldDelta.x; c.y+=worldDelta.y; save(); }
    }else{
      const n=getNode(gesture.dragSel.id);
      if(n){ n.x+=worldDelta.x; n.y+=worldDelta.y; save(); }
    }
  }
}

function pointerUp(e){
  if(!pointers.has(e.pointerId)) return;

  const p = pointers.get(e.pointerId);
  const upAt = performance.now();
  const hit = p.hitAtStart;

  pointers.delete(e.pointerId);
  cancelLongPress();

  // –µ—Å–ª–∏ –±—ã–ª pinch –∏ –æ—Ç–ø—É—Å—Ç–∏–ª–∏ –æ–¥–∏–Ω –ø–∞–ª–µ—Ü ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ pan
  if(gesture.mode==="pinch"){
    if(pointers.size===1){
      gesture.mode = "pan";
      gesture.dragSel = null;
    }else{
      gesture.mode = "none";
      gesture.dragSel = null;
    }
    return;
  }

  // middle mouse pan end
  if(gesture.mode==="midpan"){
    gesture.mode = "none";
    return;
  }

  // double tap / double click (—Å–æ–∑–¥–∞–Ω–∏–µ)
  const isTap = !gesture.moved && (upAt - p.time) < 500;
  if(isTap){
    const now = upAt;
    const dx = p.startX - gesture.lastTapX;
    const dy = p.startY - gesture.lastTapY;
    const near = Math.hypot(dx,dy) < DOUBLE_TAP_PX;

    const isDouble = (now - gesture.lastTapAt) < DOUBLE_TAP_MS && near;

    gesture.lastTapAt = now;
    gesture.lastTapX = p.startX;
    gesture.lastTapY = p.startY;

    if(isDouble){
      // –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø/–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫: —Å–æ–∑–¥–∞—Ç—å
      const h = hitTest(p.startX, p.startY);

      if(!h){
        const wpos = screenToWorld(p.startX, p.startY);
        createCoreAtWorld(wpos.x, wpos.y);
        // —è–¥—Ä–æ —Å–æ–∑–¥–∞–ª–∏ ‚Äî –ù–ï –æ–±—è–∑–∞–Ω—ã —Å—Ä–∞–∑—É —Ä–µ–¥–∞–∫—Ç–æ—Ä, –Ω–æ –º–æ–∂–Ω–æ
        focusToSelected(true);
      }else{
        selected = h;
        addPulse(selected);

        if(h.type==="core"){
          createNode("core", h.id, h.id);
          focusToSelected(true); // –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–æ–¥–ª—ë—Ç + —Ä–µ–¥–∞–∫—Ç–æ—Ä
        }else{
          const n = getNode(h.id);
          if(n){
            createNode("node", n.id, n.coreId);
            focusToSelected(true);
          }
        }
      }
    }
  }

  gesture.mode = "none";
  gesture.dragSel = null;
  gesture.moved = false;

  try{ canvas.releasePointerCapture(e.pointerId); }catch(_){}
}

canvas.addEventListener("pointerdown", pointerDown, {passive:false});
canvas.addEventListener("pointermove", pointerMove, {passive:false});
canvas.addEventListener("pointerup", pointerUp, {passive:false});
canvas.addEventListener("pointercancel", pointerUp, {passive:false});

/* ---------- Wheel zoom + ctrl trackpad ---------- */
canvas.addEventListener("wheel",(e)=>{
  // –ø–∞–Ω (—Å—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞) —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –µ—Å—Ç—å, –Ω–æ wheel –æ—Å—Ç–∞–≤–∏–º –ø–æ–¥ zoom
  e.preventDefault();

  const sx=e.clientX, sy=e.clientY;
  const before=screenToWorld(sx,sy);

  const zoomFactor=Math.exp(-e.deltaY*0.00115);
  view.z = clamp(view.z*zoomFactor, 0.01, 30.0);

  const after=screenToWorld(sx,sy);
  view.x += (after.x-before.x)*view.z;
  view.y += (after.y-before.y)*view.z;

  save();
},{passive:false});

/* ---------- RMB: —Ñ–æ–∫—É—Å + —Ä–µ–¥–∞–∫—Ç–æ—Ä (–ü–ö–ú) ---------- */
let rmbTimer = null;
let rmbCount = 0;
let rmbLastHit = null;

canvas.addEventListener("contextmenu",(e)=>{
  e.preventDefault();
  const hit = hitTest(e.clientX, e.clientY);
  if(!hit) return;

  selected = hit;
  addPulse(selected);

  rmbLastHit = hit;
  rmbCount++;

  if(rmbTimer) clearTimeout(rmbTimer);

  rmbTimer = setTimeout(()=>{
    // –ü–ö–ú: –æ–¥–∏–Ω —Ä–∞–∑ = –ø–æ–¥–ª—ë—Ç+—Ä–µ–¥–∞–∫—Ç–æ—Ä; –¥–≤–æ–π–Ω–æ–π –ü–ö–ú = —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º—ã—Å–ª—å + –ø–æ–¥–ª—ë—Ç+—Ä–µ–¥–∞–∫—Ç–æ—Ä
    if(rmbCount >= 2){
      if(rmbLastHit.type==="core"){
        createNode("core", rmbLastHit.id, rmbLastHit.id);
      }else{
        const n = getNode(rmbLastHit.id);
        if(n) createNode("node", n.id, n.coreId);
      }
      save();
      focusToSelected(true);
    }else{
      focusToSelected(true);
    }
    rmbCount = 0;
    rmbLastHit = null;
    rmbTimer = null;
  }, 260);
});

/* ---------- Focus animation (–ø—Ä–µ–¥–∏–∫—Ç –ø–∞–Ω–µ–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ) ---------- */
function easeInOutCubic(x){
  return x < 0.5 ? 4*x*x*x : 1 - Math.pow(-2*x+2, 3)/2;
}

function focusToSelected(openEditor=true){
  const obj = getSelectedObj();
  if(!obj) return;

  // –¥–µ–ª–∞–µ–º –±–ª–∏–∂–µ, —á–µ–º —Ä–∞–Ω—å—à–µ (–∏ —Ä–µ–∞–ª—å–Ω–æ –±–µ–∑ ‚Äú—Å—Ç–æ–ø–∞‚Äù)
  const targetZ = clamp(selected.type==="node" ? 14.5 : 10.5, 0.01, 30.0);

  // –ø–æ–∑–∏—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏ –ø–æ–¥–ª—ë—Ç–µ
  const targetScreenX = Math.floor(window.innerWidth * 0.30);
  const targetScreenY = Math.floor(window.innerHeight * 0.52);

  const targetX = targetScreenX - (obj.x * targetZ);
  const targetY = targetScreenY - (obj.y * targetZ);

  const start = { x:view.x, y:view.y, z:view.z };
  const end   = { x:targetX, y:targetY, z:targetZ };

  // –∑–∞—Ä–∞–Ω–µ–µ —Å—Ç–∞–≤–∏–º –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞
  if(openEditor){
    const predictedPos = { x: targetScreenX, y: targetScreenY };
    positionPanelRightOfSelected({predictedPos, predictedZ: targetZ});
  }

  const dur = 640;
  const t0 = performance.now();

  function step(now){
    const k = clamp((now - t0)/dur, 0, 1);
    const e = easeInOutCubic(k);

    view.z = start.z + (end.z - start.z) * e;
    view.x = start.x + (end.x - start.x) * e;
    view.y = start.y + (end.y - start.y) * e;

    if(k < 1) requestAnimationFrame(step);
    else{
      save();
      if(openEditor){
        positionPanelRightOfSelected();
        openPanel();
      }
    }
  }
  requestAnimationFrame(step);
}

/* ---------- Search overlay keys ---------- */
window.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    if(elSearchOverlay.classList.contains("open")) closeSearch();
  }
});

/* ---------- –ü–∞–Ω–µ–ª—å: –º–æ–±–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–µ—Å–∞–π–∑–∞ ---------- */
function adjustPanelForMobile(){
  if(window.innerWidth < 520){
    elPanel.style.resize = "none";
    elEditorWrap.style.resize = "vertical";
    elEditorWrap.style.maxHeight = "45vh";
  }else{
    elPanel.style.resize = "both";
    elEditorWrap.style.resize = "both";
    elEditorWrap.style.maxHeight = "55vh";
  }
}
window.addEventListener("resize", adjustPanelForMobile);

/* ---------- Init ---------- */
function init(){
  resize();
  load();
  syncUITheme();
  initParticles();
  adjustPanelForMobile();
  frame();
}
init();

/* ---------- Frame ---------- */
let T=0;
function frame(){
  T++;
  drawBackground(T);
  updateAndDrawParticles(particlesFar,"far",T);
  updateAndDrawParticles(particlesNear,"near",T);
  drawWorld(T);
  requestAnimationFrame(frame);
}
</script>
</body>
</html>
