<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>–ü–æ–ª—è –∏ –ü–æ—Ç–æ–∫–∏ ‚Äî v0.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <style>
    :root{
      --glass-dark: rgba(10,14,28,0.62);
      --glass-dark-brd: rgba(255,255,255,0.14);
      --glass-dark-txt: #eaf2ff;

      --glass-light: rgba(255,255,255,0.82);
      --glass-light-brd: rgba(0,0,0,0.12);
      --glass-light-txt: #111;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: #05070d;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    canvas { display:block; }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ */
    .mode-toggle {
      position: fixed;
      top: 14px;
      right: 14px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all .25s ease;
      user-select: none;
      z-index: 50;
    }
    .mode-toggle.light {
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.12);
      color: #111;
    }

    /* –ö–Ω–æ–ø–∫–∞ –ø–æ–º–æ—â–∏ */
    .help-btn{
      position: fixed;
      left: 14px;
      bottom: 14px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      user-select:none;
      z-index: 50;
    }
    .help-btn.light{
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.12);
      color:#111;
    }

    /* –û–∫–Ω–æ –ø–æ–º–æ—â–∏ —Ä—è–¥–æ–º —Å ? */
    .help-pop{
      position: fixed;
      left: 14px;
      bottom: 64px;
      width: 320px;
      max-width: calc(100vw - 28px);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-dark-brd);
      background: var(--glass-dark);
      color: var(--glass-dark-txt);
      padding: 12px;
      box-sizing: border-box;
      display:none;
      z-index: 60;
    }
    .help-pop.open{ display:block; }
    .help-pop.light{
      border-color: var(--glass-light-brd);
      background: var(--glass-light);
      color: var(--glass-light-txt);
    }
    .help-title{
      font-size: 13px;
      font-weight: 700;
      margin: 0 0 8px;
      opacity: .95;
    }
    .help-list{
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
      line-height: 1.35;
      opacity: .9;
    }
    .help-list li{ margin: 4px 0; }
    .kbd{
      font-variant-numeric: tabular-nums;
      border: 1px solid rgba(255,255,255,.18);
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 12px;
      opacity: .9;
    }
    .help-pop.light .kbd{ border-color: rgba(0,0,0,.18); }

    /* –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .panel{
      position: fixed;
      left: 12px;
      top: 12px;

      width: 340px;
      max-width: calc(100vw - 24px);

      height: auto;
      max-height: min(520px, 70vh);
      overflow: auto;

      border-radius: 18px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-dark-brd);
      background: var(--glass-dark);
      color: var(--glass-dark-txt);

      padding: 12px;
      box-sizing: border-box;

      opacity: 0;
      transform: translate3d(0,0,0) scale(0.98);
      pointer-events: none;

      transition: opacity .16s ease, transform .16s ease;
      z-index: 45;
    }
    .panel.open{
      opacity: 1;
      transform: translate3d(0,0,0) scale(1);
      pointer-events: auto;
    }
    .panel.light{
      border-color: var(--glass-light-brd);
      background: var(--glass-light);
      color: var(--glass-light-txt);
    }

    .panel-head{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      user-select:none;
      cursor: grab;
      padding: 2px 2px 8px;
    }
    .panel-head:active{ cursor: grabbing; }

    .panel h3{
      margin: 0;
      font-size: 13px;
      font-weight: 750;
      opacity: .95;
    }
    .muted{
      opacity: .72;
      font-size: 12px;
      line-height: 1.25;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin: 10px 0;
    }
    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: inherit;
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-size: 13px;
    }
    .panel.light .btn{
      border-color: rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.04);
    }

    .icon-btn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
    }

    .input, .textarea{
      width: 100%;
      box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: inherit;
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      font-size: 14px;
    }
    .panel.light .input, .panel.light .textarea{
      border-color: rgba(0,0,0,0.14);
      background: rgba(0,0,0,0.03);
    }
    .textarea{ min-height: 120px; resize: vertical; }

    /* –ü–æ–∏—Å–∫ */
    .searchOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 10vh;
      z-index: 70;
    }
    .searchOverlay.open{ display:flex; }

    .searchBox{
      width: min(360px, calc(100vw - 24px));
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,14,28,0.72);
      color: #eaf2ff;
      overflow: hidden;
    }
    .searchBox.light{
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.12);
      color: #111;
    }
    .searchInput{
      width: 100%;
      border: 0;
      outline: none;
      padding: 12px 12px;
      font-size: 14px;
      background: transparent;
      color: inherit;
      box-sizing: border-box;
    }
    .searchInput::placeholder{ opacity: .45; }

    .results{
      max-height: 38vh;
      overflow: auto;
      border-top: 1px solid rgba(255,255,255,0.12);
    }
    .searchBox.light .results{ border-top-color: rgba(0,0,0,0.10); }

    .item{
      padding: 9px 12px;
      cursor: pointer;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }
    .item:hover{ background: rgba(255,255,255,0.06); }
    .searchBox.light .item:hover{ background: rgba(0,0,0,0.04); }

    .tag{
      opacity:.62;
      font-size: 12px;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<canvas id="field"></canvas>

<div class="mode-toggle" id="modeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ">‚óê</div>

<button class="help-btn" id="helpBtn" title="–ü–æ–º–æ—â—å">?</button>
<div class="help-pop" id="helpPop">
  <div class="help-title">–ö–æ—Ä–æ—Ç–∫–æ</div>
  <ul class="help-list">
    <li>–í—ã–¥–µ–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç: –∫–ª–∏–∫</li>
    <li>–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ–∫—É—Å + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –∏–ª–∏ <span class="kbd">Enter</span></li>
    <li>–°–æ–∑–¥–∞—Ç—å —è–¥—Ä–æ: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ—Ç–µ</li>
    <li>–°–æ–∑–¥–∞—Ç—å –º—ã—Å–ª—å: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —è–¥—Ä—É</li>
    <li>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ: <span class="kbd">Del</span> (–∏–ª–∏ <span class="kbd">Backspace</span>)</li>
    <li>–ü–æ–∏—Å–∫: <span class="kbd">Ctrl</span>+<span class="kbd">K</span></li>
    <li>–ü–∞–Ω–æ—Ä–∞–º–∞: —Ç–∞—â–∏ —Ñ–æ–Ω ‚Ä¢ –ó—É–º: –∫–æ–ª–µ—Å–æ</li>
    <li>–ü–µ—Ä–µ–º–µ—â–∞—Ç—å –ø–∞–Ω–µ–ª—å: —Ç–∞—â–∏ –∑–∞ –≤–µ—Ä—Ö–Ω—é—é —Å—Ç—Ä–æ–∫—É</li>
  </ul>
</div>

<div class="panel" id="panel">
  <div class="panel-head" id="panelDrag">
    <div>
      <h3 id="panelTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
      <div class="muted" id="panelMeta" style="margin-top:4px;"></div>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn icon-btn" id="btnDelete" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
      <button class="btn icon-btn" id="panelClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
  </div>

  <div class="muted" style="margin-bottom:6px;">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
  <input class="input" id="editTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>

  <div style="height:10px;"></div>

  <div class="muted" style="margin-bottom:6px;">–¢–µ–∫—Å—Ç</div>
  <textarea class="textarea" id="editBody" placeholder="–°–º—ã—Å–ª, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞, –ø—Ä–∏–º–µ—Ä‚Ä¶"></textarea>
</div>

<div class="searchOverlay" id="searchOverlay">
  <div class="searchBox" id="searchBox">
    <input class="searchInput" id="searchInput" placeholder="–ù–∞–π—Ç–∏ —è–¥—Ä–æ/–º—ã—Å–ª—å‚Ä¶  (Esc)"/>
    <div class="results" id="results"></div>
  </div>
</div>

<script>
/* =========================================================
   –ü–æ–ª—è –∏ –ü–æ—Ç–æ–∫–∏ v0.4
   - –£–±—Ä–∞–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "‚Ä¶"
   - Delete/Backspace —É–¥–∞–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
   - –ö–ª–∏–∫ = –≤—ã–¥–µ–ª–∏—Ç—å, –ù–ï –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å
   - Enter –∏–ª–∏ dblclick –ø–æ –æ–±—ä–µ–∫—Ç—É = —Ñ–æ–∫—É—Å + –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞
   - –ü–∞–Ω–µ–ª—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–∞—è, —Å "–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º"
   - –ñ–∏–≤–æ–π light-mode (—á–∞—Å—Ç–∏—Ü—ã –≤–∏–¥–Ω—ã)
   - –°–≤–µ—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –∫–æ–ª–µ—Ü
   - –õ–∏–Ω–∏–∏ —Å–ª–µ–≥–∫–∞ "–¥—ã—à–∞—Ç" —É –≤—Å–µ—Ö —Å–≤—è–∑–µ–π
========================================================= */

const canvas = document.getElementById("field");
const ctx = canvas.getContext("2d");

const elToggle = document.getElementById("modeToggle");

const elHelpBtn = document.getElementById("helpBtn");
const elHelpPop = document.getElementById("helpPop");

const elPanel = document.getElementById("panel");
const elPanelClose = document.getElementById("panelClose");
const elPanelTitle = document.getElementById("panelTitle");
const elPanelMeta = document.getElementById("panelMeta");
const elEditTitle = document.getElementById("editTitle");
const elEditBody = document.getElementById("editBody");
const elBtnDelete = document.getElementById("btnDelete");
const elPanelDrag = document.getElementById("panelDrag");

const elSearchOverlay = document.getElementById("searchOverlay");
const elSearchBox = document.getElementById("searchBox");
const elSearchInput = document.getElementById("searchInput");
const elResults = document.getElementById("results");

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function rand(min,max){ return min + Math.random()*(max-min); }
function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

let mode = "deep"; // deep | focus

/* ---------- –ö–∞–º–µ—Ä–∞ ---------- */
let view = { x: 0, y: 0, z: 1.0 };

/* ---------- DPI ---------- */
let w=0,h=0,cx=0,cy=0,DPR=1;
function resize(){
  DPR = clamp(window.devicePixelRatio||1, 1, 2);
  w = Math.floor(window.innerWidth);
  h = Math.floor(window.innerHeight);
  canvas.width  = Math.floor(w*DPR);
  canvas.height = Math.floor(h*DPR);
  canvas.style.width = w+"px";
  canvas.style.height = h+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
  cx = w/2; cy = h/2;

  syncUITheme();
  initParticles();

  if(elPanel.classList.contains("open") && !panelPinned) positionPanelForFocus();
}
window.addEventListener("resize", resize);

/* ---------- –î–∞–Ω–Ω—ã–µ ---------- */
const STORAGE_KEY = "fields_flows_v04";

let state = { cores: [], nodes: [] };
let selected = null; // {type:'core'|'node', id:...}

/* ---------- Default ---------- */
function defaultState(){
  const c1 = {id: uid("core"), title:"–û—Å–Ω–æ–≤—ã", body:"", x: -220, y: -80, r: 26, hue: 210};
  const c2 = {id: uid("core"), title:"–ü—Ä–∞–∫—Ç–∏–∫–∞", body:"", x:  180, y:-120, r: 22, hue: 220};
  const c3 = {id: uid("core"), title:"–ò–¥–µ–∏",    body:"", x:  120, y: 140, r: 28, hue: 205};
  const c4 = {id: uid("core"), title:"–õ–∏—á–Ω–æ–µ",  body:"", x: -160, y: 160, r: 20, hue: 230};
  return { cores:[c1,c2,c3,c4], nodes:[] };
}

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      state = defaultState();
      view.x = cx; view.y = cy; view.z = 1.0;
      save();
      return;
    }
    state = JSON.parse(raw);
    if(!state || !Array.isArray(state.cores) || !Array.isArray(state.nodes)){
      state = defaultState();
    }
    if(state._view) view = state._view;
    else { view.x=cx; view.y=cy; view.z=1.0; }
  } catch(e){
    state = defaultState();
    view.x=cx; view.y=cy; view.z=1.0;
  }
}
function save(){
  state._view = view;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ---------- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ---------- */
function worldToScreen(wx, wy){ return { x: (wx*view.z)+view.x, y: (wy*view.z)+view.y }; }
function screenToWorld(sx, sy){ return { x: (sx-view.x)/view.z, y: (sy-view.y)/view.z }; }

/* ---------- UI theme ---------- */
function syncUITheme(){
  const isLight = mode==="focus";
  elToggle.classList.toggle("light", isLight);
  elPanel.classList.toggle("light", isLight);
  elHelpBtn.classList.toggle("light", isLight);
  elHelpPop.classList.toggle("light", isLight);
  elSearchBox.classList.toggle("light", isLight);
}

/* ---------- Help ---------- */
elHelpBtn.addEventListener("click", ()=>{
  elHelpPop.classList.toggle("open");
});
window.addEventListener("mousedown",(e)=>{
  // –∫–ª–∏–∫ –≤–Ω–µ –ø–æ–º–æ—â–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ—ë (–Ω–æ –Ω–µ –º–µ—à–∞–µ—Ç –∫–ª–∏–∫–∞–º –ø–æ canvas)
  if(elHelpPop.classList.contains("open")){
    const inPop = elHelpPop.contains(e.target);
    const inBtn = elHelpBtn.contains(e.target);
    if(!inPop && !inBtn) elHelpPop.classList.remove("open");
  }
});

/* ---------- –ß–∞—Å—Ç–∏—Ü—ã ---------- */
let particlesFar=[], particlesNear=[];
function makeParticle(layer){
  const isFar = layer==="far";
  const baseSize = isFar ? rand(0.4,1.4) : rand(0.8,2.6);
  return {
    x: rand(0,w), y: rand(0,h),
    vx: isFar ? rand(-0.06,0.06) : rand(-0.14,0.14),
    vy: isFar ? rand(-0.04,0.04) : rand(-0.10,0.10),
    z: rand(0.2,1.0),
    vz: isFar ? rand(-0.0006,0.0006) : rand(-0.0012,0.0012),
    tw: rand(0,Math.PI*2),
    twSpeed: isFar ? rand(0.010,0.024) : rand(0.014,0.032),
    size: baseSize,
    baseAlpha: isFar ? rand(0.14,0.40) : rand(0.12,0.34),
    sparkle: Math.random() < (isFar ? 0.06 : 0.04),
    sparkleT: rand(0,9999),
  };
}
function initParticles(){
  const farCount  = Math.round((w*h)/42000);
  const nearCount = Math.round((w*h)/26000);
  particlesFar  = Array.from({length: Math.min(140, Math.max(22, farCount))}, () => makeParticle("far"));
  particlesNear = Array.from({length: Math.min(210, Math.max(34, nearCount))}, () => makeParticle("near"));
}
function drawBackground(t){
  const breathe = (Math.sin(t*0.01)+1)*0.5;
  const grd = ctx.createRadialGradient(
    cx + (mode==="deep" ? (breathe-0.5)*30 : (breathe-0.5)*14),
    cy + (mode==="deep" ? (0.5-breathe)*24 : (0.5-breathe)*10),
    120, cx, cy, Math.max(w,h)
  );
  if(mode==="deep"){
    grd.addColorStop(0, "#0b1022");
    grd.addColorStop(0.55,"#040611");
    grd.addColorStop(1, "#02030a");
  }else{
    grd.addColorStop(0, "#f7f9ff");
    grd.addColorStop(0.6,"#edf1ff");
    grd.addColorStop(1, "#dfe6ff");
  }
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,w,h);

  // –í light —Ä–µ–∂–∏–º–µ –ù–ï –¥–µ–ª–∞–µ–º –ø–ª–æ—Ç–Ω—É—é –±–µ–ª—É—é –ø–µ–ª–µ–Ω—É ‚Äî –æ–Ω–∞ —É–±–∏–≤–∞–µ—Ç –∂–∏–∑–Ω—å.
  if(mode==="deep"){
    ctx.fillStyle="rgba(10,14,28,0.08)";
    ctx.fillRect(0,0,w,h);
  }else{
    ctx.fillStyle="rgba(255,255,255,0.10)";
    ctx.fillRect(0,0,w,h);
  }
}
function updateAndDrawParticles(list, layer, t){
  const isFar = layer==="far";
  const speedMul = (mode==="deep") ? 1.0 : 1.12;

  // –¶–≤–µ—Ç–∞ —á–∞—Å—Ç–∏—Ü: –≤ —Å–≤–µ—Ç–ª–æ–º —Ä–µ–∂–∏–º–µ –¥–µ–ª–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–µ–µ (—Å–∏–Ω–µ–≤–∞—Ç–æ-—Å–µ—Ä—ã–µ)
  let r,g,b;
  if(mode==="deep"){ r=170; g=205; b=255; }
  else { r=55; g=75; b=145; }

  for(const p of list){
    p.x += p.vx * speedMul * (0.6+p.z);
    p.y += p.vy * speedMul * (0.6+p.z);
    p.z += p.vz;
    if(p.z<0.15 || p.z>1.15) p.vz *= -1;
    if(p.x<-20) p.x=w+20;
    if(p.x>w+20) p.x=-20;
    if(p.y<-20) p.y=h+20;
    if(p.y>h+20) p.y=-20;

    p.tw += p.twSpeed;
    const twinkle = 0.62 + 0.38*Math.sin(p.tw);

    let spark=0;
    if(p.sparkle){
      p.sparkleT += 1;
      if((p.sparkleT % Math.floor(360 + Math.random()*620))===0) p.sparkleT=1;
      if(p.sparkleT>0 && p.sparkleT<22) spark=(22-p.sparkleT)/22;
      if(p.sparkleT>=22) p.sparkleT=0;
    }

    const alphaBase = p.baseAlpha * (isFar ? 1.0 : 0.95);
    const alphaBoost = (mode==="deep") ? 1.0 : (isFar ? 1.35 : 1.55);
    const a = Math.min(0.85, (alphaBase*alphaBoost)*twinkle + spark*(isFar?0.22:0.18));
    const s = p.size*(0.75+p.z*0.85);

    ctx.fillStyle = `rgba(${r},${g},${b},${a})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,s,0,Math.PI*2);
    ctx.fill();

    // –ª—ë–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
    const glowA = (mode==="deep") ? (a*0.14) : (a*0.10);
    ctx.fillStyle = `rgba(${r},${g},${b},${glowA})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,s*3.0,0,Math.PI*2);
    ctx.fill();
  }
}

/* ---------- –û–±—ä–µ–∫—Ç—ã ---------- */
function getCore(id){ return state.cores.find(c=>c.id===id); }
function getNode(id){ return state.nodes.find(n=>n.id===id); }

/* ---------- –°–≤—è–∑–∏ ---------- */
function getConnections(){
  // —è–¥—Ä–æ-—è–¥—Ä–æ: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–≤—è–∑—ã–≤–∞–µ–º —Å–æ—Å–µ–¥–µ–π (–∫–∞–∫ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–π –ø–æ—Ç–æ–∫)
  const links = [];
  for(let i=0;i<state.cores.length;i++){
    const a = state.cores[i];
    const b = state.cores[(i+1)%state.cores.length];
    if(a && b) links.push({aType:"core",aId:a.id,bType:"core",bId:b.id, kind:"core"});
  }
  // —è–¥—Ä–æ-—É–∑–ª—ã: —Ä–µ–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
  for(const n of state.nodes){
    links.push({aType:"core",aId:n.coreId,bType:"node",bId:n.id, kind:"node"});
  }
  return links;
}

/* ---------- –†–µ–Ω–¥–µ—Ä ---------- */
function hsl(h,s,l,a=1){ return `hsla(${h},${s}%,${l}%,${a})`; }

function drawFlows(t){
  const links = getConnections();
  const baseLine = (mode==="deep") ? "rgba(140,180,255,0.18)" : "rgba(45,65,135,0.24)";
  const coreLine = (mode==="deep") ? "rgba(140,180,255,0.24)" : "rgba(45,65,135,0.34)";
  ctx.lineCap = "round";

  for(const L of links){
    const A = (L.aType==="core") ? getCore(L.aId) : getNode(L.aId);
    const B = (L.bType==="core") ? getCore(L.bId) : getNode(L.bId);
    if(!A || !B) continue;

    const As = worldToScreen(A.x, A.y);
    const Bs = worldToScreen(B.x, B.y);

    const sway = (L.kind==="core" ? 18 : 10) * Math.sin(t*0.018 + (As.x+Bs.x)*0.0012)
               + (L.kind==="core" ? 10 : 6)  * Math.sin(t*0.006  + (As.y+Bs.y)*0.0011);

    ctx.strokeStyle = (L.kind==="core") ? coreLine : baseLine;
    ctx.lineWidth = (L.kind==="core") ? 1.4 : 1.2;

    ctx.beginPath();
    ctx.moveTo(As.x, As.y);
    ctx.quadraticCurveTo((As.x+Bs.x)/2 + sway, (As.y+Bs.y)/2 - sway, Bs.x, Bs.y);
    ctx.stroke();
  }
}

function drawCore(c, t){
  const pos = worldToScreen(c.x, c.y);
  const rWorld = (c.r ?? 24);
  const r = rWorld * view.z;

  const hue = c.hue ?? 210;
  const isSel = selected && selected.type==="core" && selected.id===c.id;

  // –°–≤–µ—á–µ–Ω–∏–µ –≤ screen-space (–Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –∑—É–º–µ)
  const blur = (mode==="deep" ? 26 : 18) * clamp(view.z, 0.75, 1.25) + (isSel ? 10 : 0);
  const fill = (mode==="deep") ? hsl(hue, 85, 65, 0.92) : hsl(hue, 75, 45, 0.92);

  ctx.shadowColor = fill;
  ctx.shadowBlur = blur;

  ctx.fillStyle = fill;
  ctx.beginPath();
  ctx.arc(pos.x, pos.y, r, 0, Math.PI*2);
  ctx.fill();

  // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ‚Äú–∂–∏–≤–æ–π‚Äù –æ—Ç–±–ª–µ—Å–∫
  ctx.shadowBlur = 0;
  ctx.fillStyle = (mode==="deep") ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.10)";
  ctx.beginPath();
  ctx.arc(pos.x - r*0.18, pos.y - r*0.18, r*0.55, 0, Math.PI*2);
  ctx.fill();

  const label = (c.title ?? "").trim();
  if(label){
    ctx.font = `${Math.max(12, 12*view.z)}px system-ui`;
    ctx.fillStyle = (mode==="deep") ? "rgba(234,242,255,0.78)" : "rgba(20,25,40,0.72)";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText(label, pos.x, pos.y + r + 10);
  }
}

function drawNode(n, t){
  const pos = worldToScreen(n.x, n.y);
  const rWorld = (n.r ?? 10);
  const r = rWorld * view.z;

  const hue = n.hue ?? 200;
  const isSel = selected && selected.type==="node" && selected.id===n.id;

  // –î–æ—á–µ—Ä–Ω–∏–µ ‚Äî —è—Ä–∫–∏–µ, –Ω–µ –±–ª–µ–¥–Ω—ã–µ
  const blur = (mode==="deep" ? 20 : 16) * clamp(view.z, 0.75, 1.25) + (isSel ? 10 : 0);
  const fill = (mode==="deep") ? hsl(hue, 90, 78, 0.92) : hsl(hue, 85, 55, 0.92);

  ctx.shadowColor = fill;
  ctx.shadowBlur = blur;

  ctx.fillStyle = fill;
  ctx.beginPath();
  ctx.arc(pos.x, pos.y, r, 0, Math.PI*2);
  ctx.fill();

  ctx.shadowBlur = 0;

  const label = (n.title ?? "").trim();
  if(label){
    ctx.font = `${Math.max(11, 11*view.z)}px system-ui`;
    ctx.fillStyle = (mode==="deep") ? "rgba(234,242,255,0.70)" : "rgba(20,25,40,0.60)";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText(label, pos.x, pos.y + r + 8);
  }
}

function drawWorld(t){
  drawFlows(t);

  for(const c of state.cores) drawCore(c, t);
  for(const n of state.nodes) drawNode(n, t);
}

/* ---------- Hit-test ---------- */
function hitTest(sx, sy){
  // nodes first
  for(let i=state.nodes.length-1;i>=0;i--){
    const n = state.nodes[i];
    const p = worldToScreen(n.x, n.y);
    const r = (n.r ?? 10) * view.z;
    const dx = sx - p.x, dy = sy - p.y;
    if(dx*dx + dy*dy <= (r+10)*(r+10)) return {type:"node", id:n.id};
  }
  for(let i=state.cores.length-1;i>=0;i--){
    const c = state.cores[i];
    const p = worldToScreen(c.x, c.y);
    const r = (c.r ?? 24) * view.z;
    const dx = sx - p.x, dy = sy - p.y;
    if(dx*dx + dy*dy <= (r+12)*(r+12)) return {type:"core", id:c.id};
  }
  return null;
}

/* ---------- –°–æ–∑–¥–∞–Ω–∏–µ ---------- */
function createCoreAtWorld(wx, wy){
  const hue = Math.round(rand(190, 235));
  const c = {id: uid("core"), title:"–ù–æ–≤—ã–π –º–∏—Ä", body:"", x: wx, y: wy, r: 24, hue};
  state.cores.push(c);
  save();
  selected = {type:"core", id:c.id};
  // –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
}
function createNodeForCore(coreId){
  const c = getCore(coreId);
  if(!c) return;
  const angle = rand(0, Math.PI*2);
  const dist = rand(76, 120);
  const hue = clamp((c.hue ?? 210) + rand(-18, 18), 0, 360);
  const n = {
    id: uid("node"),
    coreId,
    title: "–ú—ã—Å–ª—å",
    body: "",
    x: c.x + Math.cos(angle)*dist,
    y: c.y + Math.sin(angle)*dist,
    r: 10,
    hue
  };
  state.nodes.push(n);
  save();
  selected = {type:"node", id:n.id};
  // –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
}

/* ---------- –ü–∞–Ω–µ–ª—å: –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ —Ñ–æ–∫—É—Å—É ---------- */
let panelPinned = false;

function openPanel(){
  elPanel.classList.add("open");
  if(!panelPinned) positionPanelForFocus();
  refreshPanelFields();
}
function closePanel(){
  elPanel.classList.remove("open");
}
elPanelClose.onclick = closePanel;

function refreshPanelFields(){
  if(!selected) return;
  const obj = selected.type==="core" ? getCore(selected.id) : getNode(selected.id);
  if(!obj) return;

  const meta = selected.type==="core"
    ? `–Ø–¥—Ä–æ ‚Ä¢ –º—ã—Å–ª–µ–π: ${state.nodes.filter(n=>n.coreId===obj.id).length}`
    : `–ú—ã—Å–ª—å ‚Ä¢ –≤–Ω—É—Ç—Ä–∏ —è–¥—Ä–∞: ${(getCore(obj.coreId)?.title ?? "‚Äî")}`;

  elPanelMeta.textContent = meta;
  elEditTitle.value = obj.title ?? "";
  elEditBody.value  = obj.body ?? "";
}

let editTimer=null;
function scheduleEditSave(){
  clearTimeout(editTimer);
  editTimer = setTimeout(()=>{
    if(!selected) return;
    const obj = selected.type==="core" ? getCore(selected.id) : getNode(selected.id);
    if(!obj) return;

    // –í–ê–ñ–ù–û: –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º "‚Ä¶"
    obj.title = elEditTitle.value; // –∫–∞–∫ –µ—Å—Ç—å
    obj.body  = elEditBody.value;

    save();
  }, 120);
}
elEditTitle.addEventListener("input", scheduleEditSave);
elEditBody.addEventListener("input", scheduleEditSave);

/* ---------- –£–¥–∞–ª–µ–Ω–∏–µ ---------- */
function deleteSelected(){
  if(!selected) return;

  if(selected.type==="core"){
    const id = selected.id;
    state.nodes = state.nodes.filter(n=>n.coreId!==id);
    state.cores = state.cores.filter(c=>c.id!==id);
  }else{
    const id = selected.id;
    state.nodes = state.nodes.filter(n=>n.id!==id);
  }

  selected = null;
  save();
  closePanel();
}

elBtnDelete.onclick = deleteSelected;

/* ---------- –ü–æ–∏—Å–∫ ---------- */
function openSearch(){
  elSearchOverlay.classList.add("open");
  elSearchInput.value = "";
  renderResults([]);
  elSearchInput.focus();
}
function closeSearch(){ elSearchOverlay.classList.remove("open"); }

function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function renderResults(items){
  elResults.innerHTML="";
  if(items.length===0){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<span style="opacity:.55">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å‚Ä¶</span><span class="tag">Esc</span>`;
    elResults.appendChild(div);
    return;
  }
  for(const it of items){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<span>${escapeHtml(it.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</span><span class="tag">${it.type==="core"?"—è–¥—Ä–æ":"–º—ã—Å–ª—å"}</span>`;
    div.onclick=()=>{
      closeSearch();
      selected = {type: it.type, id: it.id};
      focusToSelected(true); // –∫—Ä–∞—Å–∏–≤–æ –ª–µ—Ç–∏–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
    };
    elResults.appendChild(div);
  }
}
function searchItems(q){
  q=(q||"").trim().toLowerCase();
  if(!q) return [];
  const res=[];
  for(const c of state.cores){
    const hay=((c.title||"")+" "+(c.body||"")).toLowerCase();
    if(hay.includes(q)) res.push({type:"core",id:c.id,title:c.title});
  }
  for(const n of state.nodes){
    const hay=((n.title||"")+" "+(n.body||"")).toLowerCase();
    if(hay.includes(q)) res.push({type:"node",id:n.id,title:n.title});
  }
  return res.slice(0,18);
}
elSearchInput.addEventListener("input", ()=>renderResults(searchItems(elSearchInput.value)));
elSearchOverlay.addEventListener("click", (e)=>{ if(e.target===elSearchOverlay) closeSearch(); });

/* ---------- –ö–ª–∞–≤–∏—à–∏ ---------- */
function isTypingTarget(el){
  if(!el) return false;
  const tag = (el.tagName||"").toLowerCase();
  return tag==="input" || tag==="textarea" || el.isContentEditable;
}
window.addEventListener("keydown",(e)=>{
  // Ctrl+K
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){
    e.preventDefault();
    openSearch();
    return;
  }
  // Esc closes search
  if(e.key==="Escape"){
    if(elSearchOverlay.classList.contains("open")) closeSearch();
    return;
  }

  // Delete / Backspace
  if((e.key==="Delete" || e.key==="Backspace") && !isTypingTarget(document.activeElement)){
    if(selected){
      e.preventDefault();
      deleteSelected();
    }
    return;
  }

  // Enter = focus + open panel
  if(e.key==="Enter" && !isTypingTarget(document.activeElement)){
    if(selected){
      e.preventDefault();
      focusToSelected(true);
    }
  }
});

/* ---------- –†–µ–∂–∏–º ---------- */
elToggle.onclick = ()=>{
  mode = (mode==="deep") ? "focus" : "deep";
  syncUITheme();
};

/* ---------- –ü–∞–Ω–µ–ª—å: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ drag ---------- */
function positionPanelForFocus(){
  const mobile = window.innerWidth < 520;
  if(mobile){
    elPanel.style.left = "12px";
    elPanel.style.top = "";
    elPanel.style.right = "";
    elPanel.style.bottom = "12px";
    elPanel.style.width = "calc(100vw - 24px)";
    return;
  }
  // –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç "—Ñ–æ–∫—É—Å–Ω–æ–π" —Ç–æ—á–∫–∏
  elPanel.style.bottom = "";
  elPanel.style.width = "340px";

  const left = clamp(Math.floor(window.innerWidth*0.58), 12, window.innerWidth - 12 - 340);
  const top  = clamp(Math.floor(window.innerHeight*0.14), 12, window.innerHeight - 12 - 240);

  elPanel.style.left = left + "px";
  elPanel.style.top  = top + "px";
}

let dragPanel = {on:false, ox:0, oy:0};
elPanelDrag.addEventListener("mousedown",(e)=>{
  if(window.innerWidth < 520) return; // –Ω–∞ –º–æ–±–∏–ª–µ –Ω–µ –Ω–∞–¥–æ
  dragPanel.on = true;
  panelPinned = true;
  const rect = elPanel.getBoundingClientRect();
  dragPanel.ox = e.clientX - rect.left;
  dragPanel.oy = e.clientY - rect.top;
});
window.addEventListener("mousemove",(e)=>{
  if(!dragPanel.on) return;
  const panelW = elPanel.getBoundingClientRect().width;
  const panelH = elPanel.getBoundingClientRect().height;

  let left = e.clientX - dragPanel.ox;
  let top  = e.clientY - dragPanel.oy;

  left = clamp(left, 12, window.innerWidth - 12 - panelW);
  top  = clamp(top, 12, window.innerHeight - 12 - panelH);

  elPanel.style.left = left+"px";
  elPanel.style.top  = top+"px";
});
window.addEventListener("mouseup",()=> dragPanel.on=false);

/* ---------- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à—å—é ---------- */
let pointer = { down:false, mode:"none", lastX:0,lastY:0, dragSel:null };

canvas.addEventListener("mousedown",(e)=>{
  const sx=e.clientX, sy=e.clientY;
  pointer.down=true;
  pointer.lastX=sx; pointer.lastY=sy;

  const hit=hitTest(sx,sy);
  if(hit){
    selected = hit; // —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª—è–µ–º
    // –ø–∞–Ω–µ–ª—å –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
    pointer.mode="dragObject";
    pointer.dragSel=hit;

    // bring to front
    if(hit.type==="core"){
      const idx=state.cores.findIndex(c=>c.id===hit.id);
      if(idx>=0){ const [c]=state.cores.splice(idx,1); state.cores.push(c); }
    }else{
      const idx=state.nodes.findIndex(n=>n.id===hit.id);
      if(idx>=0){ const [n]=state.nodes.splice(idx,1); state.nodes.push(n); }
    }
  }else{
    selected=null;
    pointer.mode="pan";
    pointer.dragSel=null;
    closePanel();
  }
});

window.addEventListener("mousemove",(e)=>{
  if(!pointer.down) return;
  const sx=e.clientX, sy=e.clientY;
  const dx=sx-pointer.lastX, dy=sy-pointer.lastY;
  pointer.lastX=sx; pointer.lastY=sy;

  if(pointer.mode==="pan"){
    view.x += dx;
    view.y += dy;
    save();
    return;
  }
  if(pointer.mode==="dragObject" && pointer.dragSel){
    const worldDelta={x: dx/view.z, y: dy/view.z};
    if(pointer.dragSel.type==="core"){
      const c=getCore(pointer.dragSel.id);
      if(c){ c.x+=worldDelta.x; c.y+=worldDelta.y; save(); }
    }else{
      const n=getNode(pointer.dragSel.id);
      if(n){ n.x+=worldDelta.x; n.y+=worldDelta.y; save(); }
    }
  }
});

window.addEventListener("mouseup",()=>{
  pointer.down=false;
  pointer.mode="none";
  pointer.dragSel=null;
});

/* –∑—É–º –∫–æ–ª–µ—Å–æ–º */
canvas.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const sx=e.clientX, sy=e.clientY;
  const before=screenToWorld(sx,sy);

  const zoomFactor=Math.exp(-e.deltaY*0.0012);
  view.z = clamp(view.z*zoomFactor, 0.18, 6.0);

  const after=screenToWorld(sx,sy);
  view.x += (after.x-before.x)*view.z;
  view.y += (after.y-before.y)*view.z;

  save();
},{passive:false});

/* –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ */
canvas.addEventListener("dblclick",(e)=>{
  const sx=e.clientX, sy=e.clientY;
  const hit=hitTest(sx,sy);

  if(hit){
    selected = hit;
    // dblclick –ø–æ –æ–±—ä–µ–∫—Ç—É = —Ñ–æ–∫—É—Å + –ø–∞–Ω–µ–ª—å
    focusToSelected(true);
    return;
  }

  // –ø—É—Å—Ç–æ—Ç–∞: —Å–æ–∑–¥–∞—ë–º —è–¥—Ä–æ
  const wpos=screenToWorld(sx,sy);
  createCoreAtWorld(wpos.x, wpos.y);
});

/* dblclick –ø–æ —è–¥—Ä—É –¥–ª—è –º—ã—Å–ª–∏ ‚Äî –¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ –≤—Ç–æ—Ä–æ–π dblclick: –µ—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–æ —è–¥—Ä–æ –∏ —Ç—ã double-click –ø–æ –Ω–µ–º—É */
canvas.addEventListener("dblclick",(e)=>{
  const sx=e.clientX, sy=e.clientY;
  const hit=hitTest(sx,sy);
  if(hit && hit.type==="core"){
    // –≤–º–µ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —É–∑–ª–∞ ‚Äî —Å–æ–∑–¥–∞–µ–º —É–∑–µ–ª + –æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ —É–∑–ª–∞
    createNodeForCore(hit.id);
  }
});

/* ---------- –§–û–ö–£–°: —É–ª–µ—Ç–∞–µ—Ç –≤ –ª–µ–≤—É—é —á–∞—Å—Ç—å + –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ ---------- */
function easeInOutCubic(x){
  return x < 0.5 ? 4*x*x*x : 1 - Math.pow(-2*x+2, 3)/2;
}
function getSelectedObj(){
  if(!selected) return null;
  return selected.type==="core" ? getCore(selected.id) : getNode(selected.id);
}

function focusToSelected(openEditor=true){
  const obj = getSelectedObj();
  if(!obj) return;

  // —Ü–µ–ª–µ–≤–æ–π zoom
  const targetZ = clamp(selected.type==="node" ? 4.6 : 3.3, 0.18, 6.0);

  // —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã –æ–±—ä–µ–∫—Ç –æ–∫–∞–∑–∞–ª—Å—è —Å–ª–µ–≤–∞, –ø–æ—á—Ç–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
  const targetScreenX = Math.floor(window.innerWidth * 0.30);
  const targetScreenY = Math.floor(window.innerHeight * 0.52);

  const targetX = targetScreenX - (obj.x * targetZ);
  const targetY = targetScreenY - (obj.y * targetZ);

  const start = { x:view.x, y:view.y, z:view.z };
  const end   = { x:targetX, y:targetY, z:targetZ };

  const dur = 680;
  const t0 = performance.now();

  function step(now){
    const k = clamp((now - t0)/dur, 0, 1);
    const e = easeInOutCubic(k);

    view.z = start.z + (end.z - start.z) * e;
    view.x = start.x + (end.x - start.x) * e;
    view.y = start.y + (end.y - start.y) * e;

    if(k < 1) requestAnimationFrame(step);
    else{
      save();
      if(openEditor){
        if(!panelPinned) positionPanelForFocus();
        openPanel();
      }
    }
  }
  requestAnimationFrame(step);
}

/* ---------- –†–µ–Ω–¥–µ—Ä-—Ü–∏–∫–ª ---------- */
let T=0;
function frame(){
  T++;
  drawBackground(T);
  updateAndDrawParticles(particlesFar,"far",T);
  updateAndDrawParticles(particlesNear,"near",T);
  drawWorld(T);
  requestAnimationFrame(frame);
}

/* ---------- –°—Ç–∞—Ä—Ç ---------- */
resize();
load();
syncUITheme();
frame();
</script>
</body>
</html>
